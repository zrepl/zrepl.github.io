

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Send &amp; Recv Options &mdash; zrepl  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/banner.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Replication Options" href="replication.html" />
    <link rel="prev" title="Filter Syntax" href="filter_syntax.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> zrepl
          

          
            
            <img src="../_static/zrepl.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start by Use Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview &amp; Terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="jobs.html">Job Types in Detail</a></li>
<li class="toctree-l2"><a class="reference internal" href="transports.html">Transports</a></li>
<li class="toctree-l2"><a class="reference internal" href="filter_syntax.html">Filter Syntax</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Send &amp; Recv Options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#send-options">Send Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#encrypted"><code class="docutils literal notranslate"><span class="pre">encrypted</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#properties"><code class="docutils literal notranslate"><span class="pre">properties</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#backup-properties"><code class="docutils literal notranslate"><span class="pre">backup_properties</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#large-blocks"><code class="docutils literal notranslate"><span class="pre">large_blocks</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#recv-options">Recv Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#job-recv-options-inherit-and-override"><code class="docutils literal notranslate"><span class="pre">properties</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#a-note-on-property-replication">A Note on Property Replication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mount-behaviour">Mount behaviour</a></li>
<li class="toctree-l4"><a class="reference internal" href="#systemd">Systemd</a></li>
<li class="toctree-l4"><a class="reference internal" href="#encryption">Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#placeholders">Placeholders</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#common-options">Common Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bandwidth-limit-send-recv">Bandwidth Limit (send &amp; recv)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="replication.html">Replication Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="snapshotting.html">Taking Snaphots</a></li>
<li class="toctree-l2"><a class="reference internal" href="prune.html">Pruning Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pr.html">Talks &amp; Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zrepl/zrepl">GitHub Repository &amp; Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supporters.html">Supporters</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zrepl</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../configuration.html">Configuration</a> &raquo;</li>
        
      <li>Send &amp; Recv Options</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/zrepl/zrepl/blob/master/docs/configuration/sendrecvoptions.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  


    
    



    <p class="scv-banner scv-sphinx_rtd_theme"><a href="../../stable/configuration/sendrecvoptions.html"><b>Warning:</b> This document is for the development version of zrepl. The main version is stable.</a></p>
<div class="section" id="send-recv-options">
<h1>Send &amp; Recv Options<a class="headerlink" href="#send-recv-options" title="Permalink to this headline">¶</a></h1>
<div class="section" id="send-options">
<span id="job-send-options"></span><h2>Send Options<a class="headerlink" href="#send-options" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="jobs.html#job-source"><span class="std std-ref">Source</span></a> and <a class="reference internal" href="jobs.html#job-push"><span class="std std-ref">push</span></a> jobs have an optional <code class="docutils literal notranslate"><span class="pre">send</span></code> configuration section.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jobs</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">push</span>
  <span class="n">filesystems</span><span class="p">:</span> <span class="o">...</span>
  <span class="n">send</span><span class="p">:</span>
    <span class="c1"># flags from the table below go here</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>The following table specifies the list of (boolean) options.
Flags with an entry in the <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span></code> column map directly to the zfs send CLI flags.
zrepl does not perform feature checks for these flags.
If you enable a flag that is not supported by the installed version of ZFS, the zfs error will show up at runtime in the logs and zrepl status.
See the <a class="reference external" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-send.8.html">upstream man page</a> (<code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">zfs-send</span></code>) for their semantics.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="10%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><code class="docutils literal notranslate"><span class="pre">send.</span></code></th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span></code></th>
<th class="head">Comment</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">encrypted</span></code></td>
<td>&#160;</td>
<td>Specific to zrepl, <a class="reference internal" href="#job-send-options-encrypted"><span class="std std-ref">see below</span></a>.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">bandwidth_limit</span></code></td>
<td>&#160;</td>
<td>Specific to zrepl, <a class="reference internal" href="#job-send-recv-options-bandwidth-limit"><span class="std std-ref">see below</span></a>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">raw</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">-w</span></code></td>
<td>Use <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> to only allow encrypted sends. Mixed sends are not supported.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">send_properties</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">-p</span></code></td>
<td><strong>Be careful</strong>, read the <a class="reference internal" href="#job-note-property-replication"><span class="std std-ref">note on property replication below</span></a>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">backup_properties</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">-b</span></code></td>
<td><strong>Be careful</strong>, read the <a class="reference internal" href="#job-note-property-replication"><span class="std std-ref">note on property replication below</span></a>.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">large_blocks</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">-L</span></code></td>
<td><strong>Potential data loss on OpenZFS &lt; 2.0</strong>, see <a class="reference internal" href="#job-send-options-large-blocks"><span class="std std-ref">warning below</span></a>.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">compressed</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">-c</span></code></td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">embedded_data</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">-e</span></code></td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">saved</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">-S</span></code></td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<div class="section" id="encrypted">
<span id="job-send-options-encrypted"></span><h3><code class="docutils literal notranslate"><span class="pre">encrypted</span></code><a class="headerlink" href="#encrypted" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> option controls whether the matched filesystems are sent as <a class="reference external" href="http://open-zfs.org/wiki/ZFS-Native_Encryption">OpenZFS native encryption</a> raw sends.
More specifically, if <code class="docutils literal notranslate"><span class="pre">encrypted=true</span></code>, zrepl</p>
<ul class="simple">
<li>checks for any of the filesystems matched by <code class="docutils literal notranslate"><span class="pre">filesystems</span></code> whether the ZFS <code class="docutils literal notranslate"><span class="pre">encryption</span></code> property indicates that the filesystem is actually encrypted with ZFS native encryption and</li>
<li>invokes the <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span></code> subcommand with the <code class="docutils literal notranslate"><span class="pre">-w</span></code> option (raw sends) and</li>
<li>expects the receiving side to support OpenZFS native encryption (recv will fail otherwise)</li>
</ul>
<p>Filesystems matched by <code class="docutils literal notranslate"><span class="pre">filesystems</span></code> that are not encrypted are not sent and will cause error log messages.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">encrypted=false</span></code>, zrepl expects that filesystems matching <code class="docutils literal notranslate"><span class="pre">filesystems</span></code> are not encrypted or have loaded encryption keys.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> instead of <code class="docutils literal notranslate"><span class="pre">raw</span></code> to make your intent clear that zrepl must only replicate filesystems that are actually encrypted by OpenZFS native encryption.
It is meant as a safeguard to prevent unintended sends of unencrypted filesystems in raw mode.</p>
</div>
</div>
<div class="section" id="properties">
<span id="job-send-options-properties"></span><h3><code class="docutils literal notranslate"><span class="pre">properties</span></code><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h3>
<p>Sends the dataset properties along with snapshots.
Please be careful with this option and read the <a class="reference internal" href="#job-note-property-replication"><span class="std std-ref">note on property replication below</span></a>.</p>
</div>
<div class="section" id="backup-properties">
<span id="job-send-options-backup-properties"></span><h3><code class="docutils literal notranslate"><span class="pre">backup_properties</span></code><a class="headerlink" href="#backup-properties" title="Permalink to this headline">¶</a></h3>
<p>When properties are modified on a filesystem that was received from a send stream with <code class="docutils literal notranslate"><span class="pre">send.properties=true</span></code>, ZFS archives the original received value internally.
This also applies to <a class="reference internal" href="#job-recv-options-inherit-and-override"><span class="std std-ref">inheriting or overriding properties during zfs receive</span></a>.</p>
<p>When sending those received filesystems another hop, the <code class="docutils literal notranslate"><span class="pre">backup_properties</span></code> flag instructs ZFS to send the original property values rather than the current locally set values.</p>
<p>This is useful for replicating properties across multiple levels of backup machines.
<strong>Example:</strong>
Suppose we want to flow snapshots from Machine A to B, then from B to C.
A will enable the <a class="reference internal" href="#job-send-options-properties"><span class="std std-ref">properties send option</span></a>.
B will want to override <a class="reference internal" href="#job-note-property-replication"><span class="std std-ref">critical properties such as mountpoint or canmount</span></a>.
But the job that replicates from B to C should be sending the original property values received from A.
Thus, B sets the <code class="docutils literal notranslate"><span class="pre">backup_properties</span></code> option.</p>
<p>Please be careful with this option and read the <a class="reference internal" href="#job-note-property-replication"><span class="std std-ref">note on property replication below</span></a>.</p>
</div>
<div class="section" id="large-blocks">
<span id="job-send-options-large-blocks"></span><h3><code class="docutils literal notranslate"><span class="pre">large_blocks</span></code><a class="headerlink" href="#large-blocks" title="Permalink to this headline">¶</a></h3>
<p>This flag should not be changed after initial replication.
Prior to <a class="reference external" href="https://github.com/openzfs/zfs/pull/10383/files#diff-4c1e47568f46fb63546e984943b09a3e6b051e2242649523f7835bbdfe2a9110R337-R342">OpenZFS commit 7bcb7f08</a>
it was possible to change this setting which resulted in <strong>data loss on the receiver</strong>.
The commit in question is included in OpenZFS 2.0 and works around the problem by prohibiting receives of incremental streams with a flipped setting.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This bug has <strong>not been fixed in the OpenZFS 0.8 releases</strong> which means that changing this flag after initial replication might cause <strong>data loss</strong> on the receiver.</p>
</div>
</div>
</div>
<div class="section" id="recv-options">
<span id="job-recv-options"></span><h2>Recv Options<a class="headerlink" href="#recv-options" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="jobs.html#job-sink"><span class="std std-ref">Sink</span></a> and <a class="reference internal" href="jobs.html#job-pull"><span class="std std-ref">pull</span></a> jobs have an optional <code class="docutils literal notranslate"><span class="pre">recv</span></code> configuration section:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jobs</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">pull</span>
  <span class="n">recv</span><span class="p">:</span>
    <span class="n">properties</span><span class="p">:</span>
      <span class="n">inherit</span><span class="p">:</span>
        <span class="o">-</span> <span class="s2">&quot;mountpoint&quot;</span>
      <span class="n">override</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;org.openzfs.systemd:ignore&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span>
      <span class="p">}</span>
    <span class="n">bandwidth_limit</span><span class="p">:</span> <span class="o">...</span>
    <span class="n">placeholder</span><span class="p">:</span>
      <span class="n">encryption</span><span class="p">:</span> <span class="n">unspecified</span> <span class="o">|</span> <span class="n">off</span> <span class="o">|</span> <span class="n">inherit</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>Jump to
<a class="reference internal" href="#job-recv-options-inherit-and-override"><span class="std std-ref">properties</span></a> ,
<a class="reference internal" href="#job-send-recv-options-bandwidth-limit"><span class="std std-ref">bandwidth_limit</span></a> , and
<a class="reference internal" href="#job-recv-options-placeholder"><span class="std std-ref">bandwidth_limit</span></a>.</p>
<div class="section" id="job-recv-options-inherit-and-override">
<span id="id1"></span><h3><code class="docutils literal notranslate"><span class="pre">properties</span></code><a class="headerlink" href="#job-recv-options-inherit-and-override" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">override</span></code> maps directly to the <a class="reference external" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-recv.8.html">zfs recv -o flag</a>.
Property name-value pairs specified in this map will apply to all received filesystems, regardless of whether the send stream contains properties or not.</p>
<p><code class="docutils literal notranslate"><span class="pre">inherit</span></code> maps directly to the <a class="reference external" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-recv.8.html">zfs recv -x flag</a>.
Property names specified in this list will be inherited from the receiving side’s parent filesystem (e.g. <code class="docutils literal notranslate"><span class="pre">root_fs</span></code>).</p>
<p>With both options, the sending side’s property value is still stored on the receiver, but the local override or inherit is the one that takes effect.
You can send the original properties from the first receiver to another receiver using <a class="reference internal" href="#job-send-options-backup-properties"><span class="std std-ref">send.backup_properties</span></a>.</p>
</div>
</div>
<div class="section" id="a-note-on-property-replication">
<span id="job-note-property-replication"></span><h2>A Note on Property Replication<a class="headerlink" href="#a-note-on-property-replication" title="Permalink to this headline">¶</a></h2>
<p>If a send stream contains properties, as per <code class="docutils literal notranslate"><span class="pre">send.properties</span></code> or <code class="docutils literal notranslate"><span class="pre">send.backup_properties</span></code>,
the default ZFS behavior is to use those properties on the receiving side, verbatim.</p>
<p>In many use cases for zrepl, this can have devastating consequences.
For example, when backing up a filesystem that has <code class="docutils literal notranslate"><span class="pre">mountpoint=/</span></code> to a storage server,
that storage server’s root filesystem will be shadowed by the received file system on some platforms.
Also, many scripts and tools use ZFS user properties for configuration and do not check the property source (<code class="docutils literal notranslate"><span class="pre">local</span></code> vs. <code class="docutils literal notranslate"><span class="pre">received</span></code>).
If they are installed on the receiving side as well as the sending side, property replication could have unintended effects.</p>
<p><strong>zrepl currently does not provide any automatic safe-guards for property replication:</strong></p>
<ul class="simple">
<li>Make sure to read the entire man page on zfs recv (<a class="reference external" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-recv.8.html">man zfs recv</a>) before enabling this feature.</li>
<li>Use <code class="docutils literal notranslate"><span class="pre">recv.properties.override</span></code> whenever possible, e.g. for <code class="docutils literal notranslate"><span class="pre">mountpoint=none</span></code> or <code class="docutils literal notranslate"><span class="pre">canmount=off</span></code>.</li>
<li>Use <code class="docutils literal notranslate"><span class="pre">recv.properties.inherit</span></code> if that makes more sense to you.</li>
</ul>
<p>Below is an <strong>non-exhaustive list of problematic properties</strong>.
Please open a pull request if you find a property that is missing from this list.
(Both with regards to core ZFS tools and other software in the broader ecosystem.)</p>
<div class="section" id="mount-behaviour">
<h3>Mount behaviour<a class="headerlink" href="#mount-behaviour" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">mountpoint</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">canmount</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">overlay</span></code></li>
</ul>
<p>Note: inheriting or overriding the <code class="docutils literal notranslate"><span class="pre">mountpoint</span></code> property on ZVOLs fails in <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">recv</span></code>.
This is an <a class="reference external" href="https://github.com/openzfs/zfs/issues/11416">issue in OpenZFS</a> .
As a workaround, consider creating separate zrepl jobs for your ZVOL and filesystem datasets.
Please comment at zrepl <a class="reference external" href="https://github.com/zrepl/zrepl/issues/430">issue #430</a> if you encounter this issue and/or would like zrepl to automatically work around it.</p>
</div>
<div class="section" id="systemd">
<h3>Systemd<a class="headerlink" href="#systemd" title="Permalink to this headline">¶</a></h3>
<p>With systemd, you should also consider the properties processed by the <a class="reference external" href="https://manpages.debian.org/buster-backports/zfsutils-linux/zfs-mount-generator.8.en.html">zfs-mount-generator</a> .</p>
<p>Most notably:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">org.openzfs.systemd:ignore</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">org.openzfs.systemd:wanted-by</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">org.openzfs.systemd:required-by</span></code></li>
</ul>
</div>
<div class="section" id="encryption">
<h3>Encryption<a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h3>
<p>If the sender filesystems are encrypted but the sender does <a class="reference internal" href="overview.html#zfs-background-knowledge-plain-vs-raw-sends"><span class="std std-ref">plain sends</span></a>
and property replication is enabled, the receiver must <a class="reference internal" href="#job-recv-options-inherit-and-override"><span class="std std-ref">inherit the following properties</span></a>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">keylocation</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">keyformat</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">encryption</span></code></li>
</ul>
</div>
<div class="section" id="placeholders">
<span id="job-recv-options-placeholder"></span><h3>Placeholders<a class="headerlink" href="#placeholders" title="Permalink to this headline">¶</a></h3>
<p>During replication, zrepl <a class="reference internal" href="overview.html#replication-placeholder-property"><span class="std std-ref">creates placeholder datasets</span></a> on the receiving side if the sending side’s <code class="docutils literal notranslate"><span class="pre">filesystems</span></code> filter creates gaps in the dataset hierarchy.
This is generally fully transparent to the user.
However, with OpenZFS Native Encryption, placeholders require zrepl user attention.
Specifically, the problem is that, when zrepl attempts to create the placeholder dataset on the receiver, and that placeholder’s parent dataset is encrypted, ZFS wants to inherit encryption to the placeholder.
This is relevant to two use cases that zrepl supports:</p>
<ol class="arabic simple">
<li><strong>encrypted-send-to-untrusted-receiver</strong> In this use case, the sender sends an <a class="reference internal" href="#job-send-options-encrypted"><span class="std std-ref">encrypted send stream</span></a> and the receiver doesn’t have the key loaded.</li>
<li><strong>send-plain-encrypt-on-receive</strong> The receive-side <code class="docutils literal notranslate"><span class="pre">root_fs</span></code> dataset is encrypted, and the senders are unencrypted.
The key of <code class="docutils literal notranslate"><span class="pre">root_fs</span></code> is loaded, and the goal is that the plain sends (e.g., from production) are encrypted on-the-fly during receive, with <code class="docutils literal notranslate"><span class="pre">root_fs</span></code>’s key.</li>
</ol>
<p>For <strong>encrypted-send-to-untrusted-receiver</strong>, the placeholder datasets need to be created with <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">encryption=off</span></code>.
Without it, creation would fail with an error, indicating that the placeholder’s parent dataset’s key needs to be loaded.
But we don’t trust the receiver, so we can’t expect that to ever happen.</p>
<p>However, for <strong>send-plain-encrypt-on-receive</strong>, we cannot set <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">encryption=off</span></code>.
The reason is that if we did, any of the (non-placeholder) child datasets below the placeholder would inherit <code class="docutils literal notranslate"><span class="pre">encryption=off</span></code>, thereby silently breaking our encrypt-on-receive use case.
So, to cover this use case, we need to create placeholders without specifying <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">encryption</span></code>.
This will make <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">create</span></code> inherit the encryption mode from the parent dataset, and thereby transitively from <code class="docutils literal notranslate"><span class="pre">root_fs</span></code>.</p>
<p>The zrepl config provides the <cite>recv.placeholder.encryption</cite> knob to control this behavior.
In <code class="docutils literal notranslate"><span class="pre">undefined</span></code> mode (default), placeholder creation bails out and asks the user to configure a behavior.
In <code class="docutils literal notranslate"><span class="pre">off</span></code> mode, the placeholder is created with <code class="docutils literal notranslate"><span class="pre">encryption=off</span></code>, i.e., <strong>encrypted-send-to-untrusted-rceiver</strong> use case.
In <code class="docutils literal notranslate"><span class="pre">inherit</span></code> mode, the placeholder is created without specifying <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">encryption</span></code> at all, i.e., the <strong>send-plain-encrypt-on-receive</strong> use case.</p>
</div>
</div>
<div class="section" id="common-options">
<h2>Common Options<a class="headerlink" href="#common-options" title="Permalink to this headline">¶</a></h2>
<div class="section" id="bandwidth-limit-send-recv">
<span id="job-send-recv-options-bandwidth-limit"></span><h3>Bandwidth Limit (send &amp; recv)<a class="headerlink" href="#bandwidth-limit-send-recv" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bandwidth_limit</span><span class="p">:</span>
  <span class="nb">max</span><span class="p">:</span> <span class="mf">23.5</span> <span class="n">MiB</span> <span class="c1"># -1 is the default and disabled rate limiting</span>
  <span class="n">bucket_capacity</span><span class="p">:</span> <span class="c1"># token bucket capacity in bytes; defaults to 128KiB</span>
</pre></div>
</div>
<p>Both <code class="docutils literal notranslate"><span class="pre">send</span></code> and <code class="docutils literal notranslate"><span class="pre">recv</span></code> can be limited to a maximum bandwidth through <code class="docutils literal notranslate"><span class="pre">bandwidth_limit</span></code>.
For most users, it should be sufficient to just set <code class="docutils literal notranslate"><span class="pre">bandwidth_limit.max</span></code>.
The <code class="docutils literal notranslate"><span class="pre">bandwidth_limit.bucket_capacity</span></code> refers to the <a class="reference external" href="https://github.com/juju/ratelimit">token bucket size</a>.</p>
<p>The bandwidth limit only applies to the payload data, i.e., the ZFS send stream.
It does not account for transport protocol overheads.
The scope is the job level, i.e., all <a class="reference internal" href="replication.html#replication-option-concurrency"><span class="std std-ref">concurrent</span></a> sends or incoming receives of a job share the bandwidth limit.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="replication.html" class="btn btn-neutral float-right" title="Replication Options" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="filter_syntax.html" class="btn btn-neutral float-left" title="Filter Syntax" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Christian Schwarz

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: master
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../v0.5.0-rc1/configuration/sendrecvoptions.html">v0.5.0-rc1</a></dd>
            <dd><a href="../../v0.4.0/configuration/sendrecvoptions.html">v0.4.0</a></dd>
            <dd><a href="../../v0.3.1/configuration/sendrecvoptions.html">v0.3.1</a></dd>
            <dd><a href="../../v0.2.1/index.html">v0.2.1</a></dd>
            <dd><a href="../../v0.1.1/index.html">v0.1.1</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="sendrecvoptions.html">master</a></dd>
            <dd><a href="../../stable/configuration/sendrecvoptions.html">stable</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>