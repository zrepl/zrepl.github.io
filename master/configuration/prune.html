

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Pruning Policies &mdash; zrepl  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/banner.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="zrepl  documentation" href="../index.html"/>
        <link rel="up" title="Configuration" href="../configuration.html"/>
        <link rel="next" title="Logging" href="logging.html"/>
        <link rel="prev" title="Filter Syntax" href="filter_syntax.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> zrepl
          

          
            
            <img src="../_static/zrepl.svg" class="logo" />
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l2"><a class="reference internal" href="jobs.html">Job Types &amp; Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="transports.html">Transports</a></li>
<li class="toctree-l2"><a class="reference internal" href="filter_syntax.html">Filter Syntax</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Pruning Policies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#policy-not-replicated">Policy <code class="docutils literal"><span class="pre">not_replicated</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#policy-grid">Policy <code class="docutils literal"><span class="pre">grid</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#policy-last-n">Policy <code class="docutils literal"><span class="pre">last_n</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#policy-regex">Policy <code class="docutils literal"><span class="pre">regex</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../implementation.html">Implementation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pr.html">Talks &amp; Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zrepl/zrepl">GitHub Repository &amp; Issue Tracker</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zrepl</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../configuration.html">Configuration</a> &raquo;</li>
        
      <li>Pruning Policies</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/zrepl/zrepl/blob/master/docs/configuration/prune.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  





<div class="section" id="pruning-policies">
<span id="prune"></span><h1>Pruning Policies<a class="headerlink" href="#pruning-policies" title="Permalink to this headline">Â¶</a></h1>
<p>In zrepl, <em>pruning</em> means <em>destroying snapshots</em>.
Pruning must happen on both sides of a replication or the systems would inevitable run out of disk space at some point.</p>
<p>Typically, the requirements to temporal resolution and maximum retention time differ per side.
For example, when using zrepl to back up a busy database server, you will want high temporal resolution (snapshots every 10 min) for the last 24h in case of administrative disasters, but cannot afford to store them for much longer because you might have high turnover volume in the database.
On the receiving side, you may have more disk space available, or need to comply with other backup retention policies.</p>
<p>zrepl uses a set of  <strong>keep rules</strong> to determine which snapshots shall be kept per filesystem.
<strong>A snapshot that is not kept by any rule is destroyed.</strong>
The keep rules are <strong>evaluated on the active side</strong> (<a class="reference internal" href="jobs.html#job-push"><span class="std std-ref">push</span></a> or <a class="reference internal" href="jobs.html#job-pull"><span class="std std-ref">pull job</span></a>) of the replication setup, for both active and passive side, after replication completed or was determined to have failed permanently.</p>
<p>Example Configuration:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">jobs</span><span class="p">:</span>
  <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">push</span>
    <span class="n">name</span><span class="p">:</span> <span class="o">...</span>
    <span class="n">connect</span><span class="p">:</span> <span class="o">...</span>
    <span class="n">filesystems</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
      <span class="s2">&quot;tmp&quot;</span><span class="p">:</span> <span class="n">false</span>
    <span class="p">}</span>
    <span class="n">snapshotting</span><span class="p">:</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">periodic</span>
      <span class="n">prefix</span><span class="p">:</span> <span class="n">zrepl_</span>
      <span class="n">interval</span><span class="p">:</span> <span class="mi">10</span><span class="n">m</span>
    <span class="n">pruning</span><span class="p">:</span>
      <span class="n">keep_sender</span><span class="p">:</span>
        <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">not_replicated</span>
        <span class="c1"># make sure manually created snapshots by the administrator are kept</span>
        <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">regex</span>
          <span class="n">regex</span><span class="p">:</span> <span class="s2">&quot;^manual_.*&quot;</span>
        <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">grid</span>
          <span class="n">grid</span><span class="p">:</span> <span class="mi">1</span><span class="n">x1h</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span> <span class="o">|</span> <span class="mi">24</span><span class="n">x1h</span> <span class="o">|</span> <span class="mi">14</span><span class="n">x1d</span>
          <span class="n">regex</span><span class="p">:</span> <span class="s2">&quot;^zrepl_.*&quot;</span>
      <span class="n">keep_receiver</span><span class="p">:</span>
        <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">grid</span>
          <span class="n">grid</span><span class="p">:</span> <span class="mi">1</span><span class="n">x1h</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span> <span class="o">|</span> <span class="mi">24</span><span class="n">x1h</span> <span class="o">|</span> <span class="mi">35</span><span class="n">x1d</span> <span class="o">|</span> <span class="mi">6</span><span class="n">x30d</span>
          <span class="n">regex</span><span class="p">:</span> <span class="s2">&quot;^zrepl_.*&quot;</span>
        <span class="c1"># manually created snapshots will be kept forever on receiver</span>
</pre></div>
</div>
<div class="admonition danger">
<p class="first admonition-title">Danger</p>
<p class="last">You might have <strong>existing snapshots</strong> of filesystems affected by pruning which you want to keep, i.e. not be destroyed by zrepl.
Make sure to actually add the necessary <code class="docutils literal"><span class="pre">regex</span></code> keep rules on both sides, like with <code class="docutils literal"><span class="pre">manual</span></code> in the example above.</p>
</div>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">It is currently not possible to define pruning on a source job.
The source job creates snapshots, which means that extended replication downtime will fill up the source&#8217;s zpool with snapshots, since pruning is directed by the corresponding active side (pull job).
If this is a potential risk for you, consider using <a class="reference internal" href="jobs.html#job-push"><span class="std std-ref">push mode</span></a>.</p>
</div>
<div class="section" id="policy-not-replicated">
<span id="prune-keep-not-replicated"></span><h2>Policy <code class="docutils literal"><span class="pre">not_replicated</span></code><a class="headerlink" href="#policy-not-replicated" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">jobs</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">push</span>
  <span class="n">pruning</span><span class="p">:</span>
    <span class="n">keep_sender</span><span class="p">:</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">not_replicated</span>
  <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">not_replicated</span></code> keeps all snapshots that have not been replicated to the receiving side.
It only makes sense to specify this rule on a sender (source or push job).
The state required to evaluate this rule is stored in the <a class="reference internal" href="jobs.html#replication-cursor-bookmark"><span class="std std-ref">replication cursor bookmark</span></a> on the sending side.</p>
</div>
<div class="section" id="policy-grid">
<span id="prune-keep-retention-grid"></span><h2>Policy <code class="docutils literal"><span class="pre">grid</span></code><a class="headerlink" href="#policy-grid" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span>jobs:
- type: pull
  pruning:
    keep_receiver:
    - type: grid
      regex: &quot;^zrepl_.*&quot;
      grid: 1x1h(keep=all) | 24x1h | 35x1d | 6x30d
            â                â
            ââ one hour interval
                             â
                             ââ 24 adjacent one-hour intervals
  ...
</pre></div>
</div>
<p>The retention grid can be thought of as a time-based sieve:
The <code class="docutils literal"><span class="pre">grid</span></code> field specifies a list of adjacent time intervals:
the left edge of the leftmost (first) interval is the <code class="docutils literal"><span class="pre">creation</span></code> date of the youngest snapshot.
All intervals to its right describe time intervals further in the past.</p>
<p>Each interval carries a maximum number of snapshots to keep.
It is specified via <code class="docutils literal"><span class="pre">(keep=N)</span></code>, where <code class="docutils literal"><span class="pre">N</span></code> is either <code class="docutils literal"><span class="pre">all</span></code> (all snapshots are kept) or a positive integer.
The default value is <strong>keep=1</strong>.</p>
<p>The following procedure happens during pruning:</p>
<ol class="arabic simple">
<li>The list of snapshots is filtered by the regular expression in <code class="docutils literal"><span class="pre">regex</span></code>.
Only snapshots names that match the regex are considered for this rule, all others are not affected.</li>
<li>The filtered list of snapshots is sorted by <code class="docutils literal"><span class="pre">creation</span></code></li>
<li>The left edge of the first interval is aligned to the <code class="docutils literal"><span class="pre">creation</span></code> date of the youngest snapshot</li>
<li>A list of buckets is created, one for each interval</li>
<li>The list of snapshots is split up into the buckets.</li>
<li>For each bucket<ol class="arabic">
<li>the contained snapshot list is sorted by creation.</li>
<li>snapshots from the list, oldest first, are destroyed until the specified <code class="docutils literal"><span class="pre">keep</span></code> count is reached.</li>
<li>all remaining snapshots on the list are kept.</li>
</ol>
</li>
</ol>
</div>
<div class="section" id="policy-last-n">
<span id="prune-keep-last-n"></span><h2>Policy <code class="docutils literal"><span class="pre">last_n</span></code><a class="headerlink" href="#policy-last-n" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">jobs</span><span class="p">:</span>
  <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">push</span>
    <span class="n">pruning</span><span class="p">:</span>
      <span class="n">keep_receiver</span><span class="p">:</span>
      <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">last_n</span>
        <span class="n">count</span><span class="p">:</span> <span class="mi">10</span>
  <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">last_n</span></code> keeps the last <code class="docutils literal"><span class="pre">count</span></code> snapshots (last = youngest = most recent creation date).</p>
</div>
<div class="section" id="policy-regex">
<span id="prune-keep-regex"></span><h2>Policy <code class="docutils literal"><span class="pre">regex</span></code><a class="headerlink" href="#policy-regex" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">jobs</span><span class="p">:</span>
  <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">push</span>
    <span class="n">pruning</span><span class="p">:</span>
      <span class="n">keep_receiver</span><span class="p">:</span>
      <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">regex</span>
        <span class="n">regex</span><span class="p">:</span> <span class="s2">&quot;^(zrepl|manual)_.*&quot;</span>
 <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">regex</span></code> keeps all snapshots whose names are matched by the regular expressionin <code class="docutils literal"><span class="pre">regex</span></code>.
Like all other regular expression fields in prune policies, zrepl uses Go&#8217;s <a class="reference external" href="https://golang.org/pkg/regexp/#Compile">regexp.Regexp</a> Perl-compatible regular expressions (<a class="reference external" href="https://golang.org/pkg/regexp/syntax">Syntax</a>).</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="logging.html" class="btn btn-neutral float-right" title="Logging" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="filter_syntax.html" class="btn btn-neutral" title="Filter Syntax" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Christian Schwarz.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: master
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../0.0.2/configuration/prune.html">0.0.2</a></dd>
            <dd><a href="../../0.0.3/configuration/prune.html">0.0.3</a></dd>
            <dd><a href="../../0.1.0-rc1/configuration/prune.html">0.1.0-rc1</a></dd>
            <dd><a href="../../0.1.0-rc2/configuration/prune.html">0.1.0-rc2</a></dd>
            <dd><a href="../../0.1.0-rc3/configuration/prune.html">0.1.0-rc3</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../anton_wip/configuration/prune.html">anton_wip</a></dd>
            <dd><a href="../../fix_diff_output/configuration/prune.html">fix_diff_output</a></dd>
            <dd><a href="prune.html">master</a></dd>
            <dd><a href="../../parallel_zfs_ops/configuration/prune.html">parallel_zfs_ops</a></dd>
            <dd><a href="../../push/configuration/prune.html">push</a></dd>
            <dd><a href="../../replication_error_handling/configuration/prune.html">replication_error_handling</a></dd>
            <dd><a href="../../replication_rewrite/configuration/prune.html">replication_rewrite</a></dd>
        </dl>
    </div>
</div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>