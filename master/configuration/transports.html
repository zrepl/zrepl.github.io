<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transports &mdash; zrepl  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/banner.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Filter Syntax" href="filter_syntax.html" />
    <link rel="prev" title="Job Types in Detail" href="jobs.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            zrepl
              <img src="../_static/zrepl.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start by Use Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview &amp; Terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="jobs.html">Job Types in Detail</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Transports</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tcp-transport"><code class="docutils literal notranslate"><span class="pre">tcp</span></code> Transport</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#serve">Serve</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connect">Connect</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#tls-transport"><code class="docutils literal notranslate"><span class="pre">tls</span></code> Transport</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Serve</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Connect</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mutual-tls-between-two-machines">Mutual-TLS between Two Machines</a></li>
<li class="toctree-l4"><a class="reference internal" href="#certificate-authority-using-easyrsa">Certificate Authority using EasyRSA</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ssh-stdinserver-transport"><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> Transport</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#transport-ssh-stdinserver-serve">Serve</a></li>
<li class="toctree-l4"><a class="reference internal" href="#transport-ssh-stdinserver-connect">Connect</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#local-transport"><code class="docutils literal notranslate"><span class="pre">local</span></code> Transport</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="filter_syntax.html">Filter Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="sendrecvoptions.html">Send &amp; Recv Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="replication.html">Replication Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="conflict_resolution.html">Conflict Resolution Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="snapshotting.html">Taking Snaphots</a></li>
<li class="toctree-l2"><a class="reference internal" href="prune.html">Pruning Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pr.html">Talks &amp; Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zrepl/zrepl">GitHub Repository &amp; Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://matrix.to/#/#zrepl:matrix.org">Chat: Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supporters.html">Supporters</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zrepl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../configuration.html">Configuration</a></li>
      <li class="breadcrumb-item active">Transports</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/zrepl/zrepl/blob/master/docs/configuration/transports.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             

<p class="scv-banner scv-sphinx_rtd_theme">
  <strong>
    
    You're reading the documentation for a development version.
    For the latest released version, please have a look at <a href="../../configuration/transports.html">stable</a>.
    
  </strong>
</p>


  <section id="transports">
<span id="transport"></span><h1><a class="toc-backref" href="#id6" role="doc-backlink">Transports</a><a class="headerlink" href="#transports" title="Link to this heading"></a></h1>
<p>The zrepl RPC layer uses <strong>transports</strong> to establish a single, bidirectional data stream between an active and passive job.
On the passive (serving) side, the transport also provides the <strong>client identity</strong> to the upper layers:
this string is used for access control and separation of filesystem sub-trees in <a class="reference internal" href="jobs.html#job-sink"><span class="std std-ref">sink jobs</span></a>.
Transports are specified in the <code class="docutils literal notranslate"><span class="pre">connect</span></code> or <code class="docutils literal notranslate"><span class="pre">serve</span></code> section of a job definition.</p>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#transports" id="id6">Transports</a></p>
<ul>
<li><p><a class="reference internal" href="#tcp-transport" id="id7"><code class="docutils literal notranslate"><span class="pre">tcp</span></code> Transport</a></p>
<ul>
<li><p><a class="reference internal" href="#serve" id="id8">Serve</a></p></li>
<li><p><a class="reference internal" href="#connect" id="id9">Connect</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#tls-transport" id="id10"><code class="docutils literal notranslate"><span class="pre">tls</span></code> Transport</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id11">Serve</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id12">Connect</a></p></li>
<li><p><a class="reference internal" href="#mutual-tls-between-two-machines" id="id13">Mutual-TLS between Two Machines</a></p></li>
<li><p><a class="reference internal" href="#certificate-authority-using-easyrsa" id="id14">Certificate Authority using EasyRSA</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ssh-stdinserver-transport" id="id15"><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> Transport</a></p>
<ul>
<li><p><a class="reference internal" href="#transport-ssh-stdinserver-serve" id="id16">Serve</a></p></li>
<li><p><a class="reference internal" href="#transport-ssh-stdinserver-connect" id="id17">Connect</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#local-transport" id="id18"><code class="docutils literal notranslate"><span class="pre">local</span></code> Transport</a></p></li>
</ul>
</li>
</ul>
</nav>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The <strong>client identities must be valid ZFS dataset path components</strong>
because the <a class="reference internal" href="jobs.html#job-sink"><span class="std std-ref">sink job</span></a> uses <code class="docutils literal notranslate"><span class="pre">${root_fs}/${client_identity}</span></code> to determine the client’s subtree.</p>
</div>
<section id="tcp-transport">
<span id="transport-tcp"></span><h2><a class="toc-backref" href="#id7" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">tcp</span></code> Transport</a><a class="headerlink" href="#tcp-transport" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tcp</span></code> transport uses plain TCP, which means that the data is <strong>not encrypted</strong> on the wire.
Clients are identified by their IPv4 or IPv6 addresses, and the client identity is established through a mapping on the server.</p>
<p>This transport may also be used in conjunction with network-layer encryption and/or VPN tunnels to provide encryption on the wire.
To make the IP-based client authentication effective, such solutions should provide authenticated IP addresses.
Some options to consider:</p>
<ul class="simple" id="transport-tcp-tunneling">
<li><p><a class="reference external" href="https://www.wireguard.com/">WireGuard</a>: Linux-focussed, in-kernel TLS</p></li>
<li><p><a class="reference external" href="https://openvpn.net/">OpenVPN</a>: Cross-platform VPN, uses tun on *nix</p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/IPsec">IPSec</a>: Properly standardized, in-kernel network-layer VPN</p></li>
<li><p><a class="reference external" href="http://www.tarsnap.com/spiped.html">spiped</a>: think of it as an encrypted pipe between two servers</p></li>
<li><p>SSH</p>
<ul>
<li><p><a class="reference external" href="https://sshuttle.readthedocs.io/en/stable/overview.html">sshuttle</a>: VPN-like solution, but using SSH</p></li>
<li><p><a class="reference external" href="https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding">SSH port forwarding</a>: Systemd user unit &amp; make it start before the zrepl service.</p></li>
</ul>
</li>
</ul>
<section id="serve">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Serve</a><a class="headerlink" href="#serve" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
-<span class="w"> </span>type:<span class="w"> </span>sink
<span class="w">  </span>serve:
<span class="w">    </span>type:<span class="w"> </span>tcp
<span class="w">    </span>listen:<span class="w"> </span><span class="s2">&quot;:8888&quot;</span>
<span class="w">    </span>listen_freebind:<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="c1"># optional, default false</span>
<span class="w">    </span>clients:<span class="w"> </span><span class="o">{</span>
<span class="w">      </span><span class="s2">&quot;192.168.122.123&quot;</span><span class="w"> </span>:<span class="w">               </span><span class="s2">&quot;mysql01&quot;</span>,
<span class="w">      </span><span class="s2">&quot;192.168.122.42&quot;</span><span class="w"> </span>:<span class="w">                </span><span class="s2">&quot;mx01&quot;</span>,
<span class="w">      </span><span class="s2">&quot;2001:0db8:85a3::8a2e:0370:7334&quot;</span>:<span class="w"> </span><span class="s2">&quot;gateway&quot;</span>,

<span class="w">      </span><span class="c1"># CIDR masks require a &#39;*&#39; in the client identity string</span>
<span class="w">      </span><span class="c1"># that is expanded to the client&#39;s IP address</span>

<span class="w">      </span><span class="s2">&quot;10.23.42.0/24&quot;</span>:<span class="w">       </span><span class="s2">&quot;cluster-*&quot;</span>
<span class="w">      </span><span class="s2">&quot;fde4:8dba:82e1::/64&quot;</span>:<span class="w"> </span><span class="s2">&quot;san-*&quot;</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">  </span>...
</pre></div>
</div>
<p id="listen-freebind-explanation"><code class="docutils literal notranslate"><span class="pre">listen_freebind</span></code> controls whether the socket is allowed to bind to non-local or unconfigured IP addresses (Linux <code class="docutils literal notranslate"><span class="pre">IP_FREEBIND</span></code> , FreeBSD <code class="docutils literal notranslate"><span class="pre">IP_BINDANY</span></code>).
Enable this option if you want to <code class="docutils literal notranslate"><span class="pre">listen</span></code> on a specific IP address that might not yet be configured when the zrepl daemon starts.</p>
</section>
<section id="connect">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Connect</a><a class="headerlink" href="#connect" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
<span class="w"> </span>-<span class="w"> </span>type:<span class="w"> </span>push
<span class="w">   </span>connect:
<span class="w">     </span>type:<span class="w"> </span>tcp
<span class="w">     </span>address:<span class="w"> </span><span class="s2">&quot;10.23.42.23:8888&quot;</span>
<span class="w">     </span>dial_timeout:<span class="w"> </span><span class="c1"># optional, default 10s</span>
<span class="w">   </span>...
</pre></div>
</div>
</section>
</section>
<section id="tls-transport">
<span id="transport-tcp-tlsclientauth"></span><h2><a class="toc-backref" href="#id10" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">tls</span></code> Transport</a><a class="headerlink" href="#tls-transport" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tls</span></code> transport uses TCP + TLS with client authentication using client certificates.
The client identity is the common name (CN) presented in the client certificate.</p>
<p>It is recommended to set up a dedicated CA infrastructure for this transport, e.g. using OpenVPN’s <a class="reference external" href="https://github.com/OpenVPN/easy-rsa">EasyRSA</a>.
For a simple 2-machine setup, mutual TLS might also be sufficient.
We provide <a class="reference internal" href="#transport-tcp-tlsclientauth-certgen"><span class="std std-ref">copy-pastable instructions to generate the certificates below</span></a>.</p>
<p>The implementation uses <a class="reference external" href="https://golang.org/pkg/crypto/tls/">Go’s TLS library</a>.
Since Go binaries are statically linked, you or your distribution need to recompile zrepl when vulnerabilities in that library are disclosed.</p>
<p>All file paths are resolved relative to the zrepl daemon’s working directory.
Specify absolute paths if you are unsure what directory that is (or find out from your init system).</p>
<p>If intermediate CAs are used, the <strong>full chain</strong> must be present in either in the <code class="docutils literal notranslate"><span class="pre">ca</span></code> file or the individual <code class="docutils literal notranslate"><span class="pre">cert</span></code> files.
Regardless, the client’s certificate must be first in the <code class="docutils literal notranslate"><span class="pre">cert</span></code> file, with each following certificate directly certifying the one preceding it (see <a class="reference external" href="https://tools.ietf.org/html/rfc5246#section-7.4.2">TLS’s specification</a>).
This is the common default when using a CA management tool.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As of Go 1.15 (zrepl 0.3.0 and newer), the Go TLS / x509 library <strong>requrires Subject Alternative Names</strong>
be present in certificates. You might need to re-generate your certificates using one of the <a class="reference internal" href="#transport-tcp-tlsclientauth-certgen"><span class="std std-ref">two alternatives
provided below</span></a>.</p>
<p>Note further that zrepl continues to use the CommonName field to assign client identities.
Hence, we recommend to keep the Subject Alternative Name and the CommonName in sync.</p>
</div>
<section id="id1">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Serve</a><a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
<span class="w">  </span>-<span class="w"> </span>type:<span class="w"> </span>sink
<span class="w">    </span>root_fs:<span class="w"> </span><span class="s2">&quot;pool2/backup_laptops&quot;</span>
<span class="w">    </span>serve:
<span class="w">      </span>type:<span class="w"> </span>tls
<span class="w">      </span>listen:<span class="w"> </span><span class="s2">&quot;:8888&quot;</span>
<span class="w">      </span>listen_freebind:<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="c1"># optional, default false</span>
<span class="w">      </span>ca:<span class="w">   </span>/etc/zrepl/ca.crt
<span class="w">      </span>cert:<span class="w"> </span>/etc/zrepl/prod.fullchain
<span class="w">      </span>key:<span class="w">  </span>/etc/zrepl/prod.key
<span class="w">      </span>client_cns:
<span class="w">        </span>-<span class="w"> </span><span class="s2">&quot;laptop1&quot;</span>
<span class="w">        </span>-<span class="w"> </span><span class="s2">&quot;homeserver&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ca</span></code> field specified the certificate authority used to validate client certificates.
The <code class="docutils literal notranslate"><span class="pre">client_cns</span></code> list specifies a list of accepted client common names (which are also the client identities for this transport).
The <code class="docutils literal notranslate"><span class="pre">listen_freebind</span></code> field is <a class="reference internal" href="#listen-freebind-explanation"><span class="std std-ref">explained here</span></a>.</p>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Connect</a><a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
-<span class="w"> </span>type:<span class="w"> </span>pull
<span class="w">  </span>connect:
<span class="w">    </span>type:<span class="w"> </span>tls
<span class="w">    </span>address:<span class="w"> </span><span class="s2">&quot;server1.foo.bar:8888&quot;</span>
<span class="w">    </span>ca:<span class="w">   </span>/etc/zrepl/ca.crt
<span class="w">    </span>cert:<span class="w"> </span>/etc/zrepl/backupserver.fullchain
<span class="w">    </span>key:<span class="w">  </span>/etc/zrepl/backupserver.key
<span class="w">    </span>server_cn:<span class="w"> </span><span class="s2">&quot;server1&quot;</span>
<span class="w">    </span>dial_timeout:<span class="w"> </span><span class="c1"># optional, default 10s</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ca</span></code> field specifies the CA which signed the server’s certificate (<code class="docutils literal notranslate"><span class="pre">serve.cert</span></code>).
The <code class="docutils literal notranslate"><span class="pre">server_cn</span></code> specifies the expected common name (CN) of the server’s certificate.
It overrides the hostname specified in <code class="docutils literal notranslate"><span class="pre">address</span></code>.
The connection fails if either do not match.</p>
</section>
<section id="mutual-tls-between-two-machines">
<span id="transport-tcp-tlsclientauth-2machineopenssl"></span><span id="transport-tcp-tlsclientauth-certgen"></span><h3><a class="toc-backref" href="#id13" role="doc-backlink">Mutual-TLS between Two Machines</a><a class="headerlink" href="#mutual-tls-between-two-machines" title="Link to this heading"></a></h3>
<p>However, for a two-machine setup, self-signed certificates distributed using an out-of-band mechanism will also work just fine:</p>
<p>Suppose you have a push-mode setup, with <cite>backups.example.com</cite> running the <a class="reference internal" href="jobs.html#job-sink"><span class="std std-ref">sink job</span></a>, and <cite>prod.example.com</cite> running the <a class="reference internal" href="jobs.html#job-push"><span class="std std-ref">push job</span></a>.
Run the following OpenSSL commands on each host, substituting HOSTNAME in both filenames and the interactive input prompt by OpenSSL:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span><span class="nv">name</span><span class="o">=</span>HOSTNAME<span class="p">;</span><span class="w"> </span>openssl<span class="w"> </span>req<span class="w"> </span>-x509<span class="w"> </span>-sha256<span class="w"> </span>-nodes<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-newkey<span class="w"> </span>rsa:4096<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-keyout<span class="w"> </span><span class="nv">$name</span>.key<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-out<span class="w"> </span><span class="nv">$name</span>.crt<span class="w"> </span>-addext<span class="w"> </span><span class="s2">&quot;subjectAltName = DNS:</span><span class="nv">$name</span><span class="s2">&quot;</span><span class="w"> </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=</span><span class="nv">$name</span><span class="s2">&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Now copy each machine’s <code class="docutils literal notranslate"><span class="pre">HOSTNAME.crt</span></code> to the other machine’s <code class="docutils literal notranslate"><span class="pre">/etc/zrepl/HOSTNAME.crt</span></code>, for example using <cite>scp</cite>.
The serve &amp; connect configuration will thus look like the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># on backups.example.com</span>
-<span class="w"> </span>type:<span class="w"> </span>sink
<span class="w">  </span>serve:
<span class="w">    </span>type:<span class="w"> </span>tls
<span class="w">    </span>listen:<span class="w"> </span><span class="s2">&quot;:8888&quot;</span>
<span class="w">    </span>ca:<span class="w"> </span><span class="s2">&quot;/etc/zrepl/prod.example.com.crt&quot;</span>
<span class="w">    </span>cert:<span class="w"> </span><span class="s2">&quot;/etc/zrepl/backups.example.com.crt&quot;</span>
<span class="w">    </span>key:<span class="w"> </span><span class="s2">&quot;/etc/zrepl/backups.example.com.key&quot;</span>
<span class="w">    </span>client_cns:
<span class="w">      </span>-<span class="w"> </span><span class="s2">&quot;prod.example.com&quot;</span>
<span class="w">  </span>...

<span class="c1"># on prod.example.com</span>
-<span class="w"> </span>type:<span class="w"> </span>push
<span class="w">  </span>connect:
<span class="w">    </span>type:<span class="w"> </span>tls
<span class="w">    </span>address:<span class="s2">&quot;backups.example.com:8888&quot;</span>
<span class="w">    </span>ca:<span class="w"> </span>/etc/zrepl/backups.example.com.crt
<span class="w">    </span>cert:<span class="w"> </span>/etc/zrepl/prod.example.com.crt
<span class="w">    </span>key:<span class="w">  </span>/etc/zrepl/prod.example.com.key
<span class="w">    </span>server_cn:<span class="w"> </span><span class="s2">&quot;backups.example.com&quot;</span>
<span class="w">  </span>...
</pre></div>
</div>
</section>
<section id="certificate-authority-using-easyrsa">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Certificate Authority using EasyRSA</a><a class="headerlink" href="#certificate-authority-using-easyrsa" title="Link to this heading"></a></h3>
<p>For more than two machines, it might make sense to set up a CA infrastructure.
Tools like <a class="reference external" href="https://github.com/OpenVPN/easy-rsa">EasyRSA</a> make this very easy:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="nv">HOSTS</span><span class="o">=(</span>backupserver<span class="w"> </span>prod1<span class="w"> </span>prod2<span class="w"> </span>prod3<span class="o">)</span>

curl<span class="w"> </span>-L<span class="w"> </span>https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.7/EasyRSA-3.0.7.tgz<span class="w"> </span>&gt;<span class="w"> </span>EasyRSA-3.0.7.tgz
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;157d2e8c115c3ad070c1b2641a4c9191e06a32a8e50971847a718251eeb510a8  EasyRSA-3.0.7.tgz&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sha256sum<span class="w"> </span>-c
rm<span class="w"> </span>-rf<span class="w"> </span>EasyRSA-3.0.7
tar<span class="w"> </span>-xf<span class="w"> </span>EasyRSA-3.0.7.tgz
<span class="nb">cd</span><span class="w"> </span>EasyRSA-3.0.7
./easyrsa
./easyrsa<span class="w"> </span>init-pki
./easyrsa<span class="w"> </span>build-ca<span class="w"> </span>nopass

<span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOSTS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>./easyrsa<span class="w"> </span>build-serverClient-full<span class="w"> </span><span class="nv">$host</span><span class="w"> </span>nopass
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>cert<span class="w"> </span><span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="nv">$host</span><span class="w"> </span>available<span class="w"> </span>at<span class="w"> </span>pki/issued/<span class="nv">$host</span>.crt
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>key<span class="w"> </span><span class="k">for</span><span class="w"> </span>host<span class="w"> </span><span class="nv">$host</span><span class="w"> </span>available<span class="w"> </span>at<span class="w"> </span>pki/private/<span class="nv">$host</span>.key
<span class="k">done</span>
<span class="nb">echo</span><span class="w"> </span>ca<span class="w"> </span>cert<span class="w"> </span>available<span class="w"> </span>at<span class="w"> </span>pki/ca.crt
</pre></div>
</div>
</section>
</section>
<section id="ssh-stdinserver-transport">
<span id="transport-ssh-stdinserver"></span><h2><a class="toc-backref" href="#id15" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> Transport</a><a class="headerlink" href="#ssh-stdinserver-transport" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> uses the <code class="docutils literal notranslate"><span class="pre">ssh</span></code> command and some features of the server-side SSH <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file.
It is less efficient than other transports because the data passes through two more pipes.
However, it is fairly convenient to set up and allows the zrepl daemon to not be directly exposed to the internet, because all traffic passes through the system’s SSH server.</p>
<p>The concept is inspired by <a class="reference external" href="https://git-scm.com/docs/git-shell">git shell</a> and <a class="reference external" href="https://borgbackup.readthedocs.io/en/stable/deployment.html">Borg Backup</a>.
The implementation is provided by the Go package <code class="docutils literal notranslate"><span class="pre">github.com/problame/go-netssh</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> generally provides inferior error detection and handling compared to the <code class="docutils literal notranslate"><span class="pre">tcp</span></code> and <code class="docutils literal notranslate"><span class="pre">tls</span></code> transports.
When encountering such problems, consider using  <code class="docutils literal notranslate"><span class="pre">tcp</span></code> or <code class="docutils literal notranslate"><span class="pre">tls</span></code> transports, or help improve package go-netssh.</p>
</div>
<section id="transport-ssh-stdinserver-serve">
<span id="id4"></span><h3><a class="toc-backref" href="#id16" role="doc-backlink">Serve</a><a class="headerlink" href="#transport-ssh-stdinserver-serve" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
-<span class="w"> </span>type:<span class="w"> </span><span class="nb">source</span>
<span class="w">  </span>serve:
<span class="w">    </span>type:<span class="w"> </span>stdinserver
<span class="w">    </span>client_identities:
<span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;client1&quot;</span>
<span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;client2&quot;</span>
<span class="w">  </span>...
</pre></div>
</div>
<p>First of all, note that <code class="docutils literal notranslate"><span class="pre">type=stdinserver</span></code> in this case:
Currently, only <code class="docutils literal notranslate"><span class="pre">connect.type=ssh+stdinserver</span></code> can connect to a <code class="docutils literal notranslate"><span class="pre">serve.type=stdinserver</span></code>, but we want to keep that option open for future extensions.</p>
<p>The serving job opens a UNIX socket named after <code class="docutils literal notranslate"><span class="pre">client_identity</span></code> in the runtime directory.
In our example above, that is <code class="docutils literal notranslate"><span class="pre">/var/run/zrepl/stdinserver/client1</span></code> and <code class="docutils literal notranslate"><span class="pre">/var/run/zrepl/stdinserver/client2</span></code>.</p>
<p>On the same machine, the <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">stdinserver</span> <span class="pre">$client_identity</span></code> command connects to <code class="docutils literal notranslate"><span class="pre">/var/run/zrepl/stdinserver/$client_identity</span></code>.
It then passes its stdin and stdout file descriptors to the zrepl daemon via <em>cmsg(3)</em>.
zrepl daemon in turn combines them into an object implementing <code class="docutils literal notranslate"><span class="pre">net.Conn</span></code>:
a <code class="docutils literal notranslate"><span class="pre">Write()</span></code> turns into a write to stdout, a <code class="docutils literal notranslate"><span class="pre">Read()</span></code> turns into a read from stdin.</p>
<p>Interactive use of the <code class="docutils literal notranslate"><span class="pre">stdinserver</span></code> subcommand does not make much sense.
However, we can force its execution when a user with a particular SSH pubkey connects via SSH.
This can be achieved with an entry in the <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file of the serving zrepl daemon.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># for OpenSSH &gt;= 7.2</span>
<span class="nv">command</span><span class="o">=</span><span class="s2">&quot;zrepl stdinserver CLIENT_IDENTITY&quot;</span>,restrict<span class="w"> </span>CLIENT_SSH_KEY
<span class="c1"># for older OpenSSH versions</span>
<span class="nv">command</span><span class="o">=</span><span class="s2">&quot;zrepl stdinserver CLIENT_IDENTITY&quot;</span>,no-port-forwarding,no-X11-forwarding,no-pty,no-agent-forwarding,no-user-rc<span class="w"> </span>CLIENT_SSH_KEY
</pre></div>
</div>
<ul class="simple">
<li><p>CLIENT_IDENTITY is substituted with an entry from <code class="docutils literal notranslate"><span class="pre">client_identities</span></code> in our example</p></li>
<li><p>CLIENT_SSH_KEY is substituted with the public part of the SSH keypair specified in the <code class="docutils literal notranslate"><span class="pre">connect.identity_file</span></code> directive on the connecting host.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may need to adjust the <code class="docutils literal notranslate"><span class="pre">PermitRootLogin</span></code> option in <code class="docutils literal notranslate"><span class="pre">/etc/ssh/sshd_config</span></code> to <code class="docutils literal notranslate"><span class="pre">forced-commands-only</span></code> or higher for this to work.
Refer to sshd_config(5) for details.</p>
</div>
<p>To recap, this is of how client authentication works with the <code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> transport:</p>
<ul class="simple">
<li><p>Connections to the <code class="docutils literal notranslate"><span class="pre">/var/run/zrepl/stdinserver/${client_identity}</span></code> UNIX socket are blindly trusted by zrepl daemon.
The connection client identity is the name of the socket, i.e. <code class="docutils literal notranslate"><span class="pre">${client_identity}</span></code>.</p></li>
<li><p>Thus, the runtime directory must be private to the zrepl user (this is checked by zrepl daemon)</p></li>
<li><p>The admin of the host with the serving zrepl daemon controls the <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file.</p></li>
<li><p>Thus, the administrator controls the mapping <code class="docutils literal notranslate"><span class="pre">PUBKEY</span> <span class="pre">-&gt;</span> <span class="pre">CLIENT_IDENTITY</span></code>.</p></li>
</ul>
</section>
<section id="transport-ssh-stdinserver-connect">
<span id="id5"></span><h3><a class="toc-backref" href="#id17" role="doc-backlink">Connect</a><a class="headerlink" href="#transport-ssh-stdinserver-connect" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
-<span class="w"> </span>type:<span class="w"> </span>pull
<span class="w">  </span>connect:
<span class="w">    </span>type:<span class="w"> </span>ssh+stdinserver
<span class="w">    </span>host:<span class="w"> </span>prod.example.com
<span class="w">    </span>user:<span class="w"> </span>root
<span class="w">    </span>port:<span class="w"> </span><span class="m">22</span>
<span class="w">    </span>identity_file:<span class="w"> </span>/etc/zrepl/ssh/identity
<span class="w">    </span><span class="c1"># options: # optional, default [], `-o` arguments passed to ssh</span>
<span class="w">    </span><span class="c1"># - &quot;Compression=yes&quot;</span>
<span class="w">    </span><span class="c1"># dial_timeout: 10s # optional, default 10s, max time.Duration until initial handshake is completed</span>
</pre></div>
</div>
<p>The connecting zrepl daemon</p>
<ol class="arabic simple">
<li><p>Creates a pipe</p></li>
<li><p>Forks</p></li>
<li><p>In the forked process</p>
<ol class="arabic simple">
<li><p>Replaces forked stdin and stdout with the corresponding pipe ends</p></li>
<li><p>Executes the <code class="docutils literal notranslate"><span class="pre">ssh</span></code> binary found in <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>.</p>
<ol class="arabic simple">
<li><p>The identity file (<code class="docutils literal notranslate"><span class="pre">-i</span></code>) is set to <code class="docutils literal notranslate"><span class="pre">$identity_file</span></code>.</p></li>
<li><p>The remote user, host and port correspond to those configured.</p></li>
<li><p>Further options can be specified using the <code class="docutils literal notranslate"><span class="pre">options</span></code> field, which appends each entry in the list to the command line using <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">$entry</span></code>.</p></li>
</ol>
</li>
</ol>
</li>
<li><p>Wraps the pipe ends in a <code class="docutils literal notranslate"><span class="pre">net.Conn</span></code> and returns it to the RPC layer.</p></li>
</ol>
<p>As discussed in the section above, the connecting zrepl daemon expects that <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">stdinserver</span> <span class="pre">$client_identity</span></code> is  executed automatically via an <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file entry.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">known_hosts</span></code> file used by the ssh command must contain an entry for <code class="docutils literal notranslate"><span class="pre">connect.host</span></code> prior to starting zrepl.
Thus, run the following on the pulling host’s command line (substituting <code class="docutils literal notranslate"><span class="pre">connect.host</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>-i<span class="w"> </span>/etc/zrepl/ssh/identity<span class="w"> </span>root@prod.example.com
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The environment variables of the underlying SSH process are cleared. <code class="docutils literal notranslate"><span class="pre">$SSH_AUTH_SOCK</span></code> will not be available.
It is suggested to create a separate, unencrypted SSH key solely for that purpose.</p>
</div>
</section>
</section>
<section id="local-transport">
<span id="transport-local"></span><h2><a class="toc-backref" href="#id18" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">local</span></code> Transport</a><a class="headerlink" href="#local-transport" title="Link to this heading"></a></h2>
<p>The local transport can be used to implement <a class="reference internal" href="jobs.html#replication-local"><span class="std std-ref">local replication</span></a>, i.e., push replication between a push and sink job defined in the same configuration file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">listener_name</span></code> is analogous to a hostname and must match between <code class="docutils literal notranslate"><span class="pre">serve</span></code> and <code class="docutils literal notranslate"><span class="pre">connect</span></code>.
The <code class="docutils literal notranslate"><span class="pre">client_identity</span></code> is used by the sink as documented above.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
-<span class="w"> </span>type:<span class="w"> </span>sink
<span class="w">  </span>serve:
<span class="w">    </span>type:<span class="w"> </span><span class="nb">local</span>
<span class="w">    </span>listener_name:<span class="w"> </span>localsink
<span class="w">  </span>...

-<span class="w"> </span>type:<span class="w"> </span>push
<span class="w">  </span>connect:
<span class="w">    </span>type:<span class="w"> </span><span class="nb">local</span>
<span class="w">    </span>listener_name:<span class="w"> </span>localsink
<span class="w">    </span>client_identity:<span class="w"> </span>local_backup
<span class="w">    </span>dial_timeout:<span class="w"> </span>2s<span class="w"> </span><span class="c1"># optional, 0 for no timeout</span>
<span class="w">  </span>...
</pre></div>
</div>
</section>
</section>



           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="jobs.html" class="btn btn-neutral float-left" title="Job Types in Detail" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="filter_syntax.html" class="btn btn-neutral float-right" title="Filter Syntax" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2023, Christian Schwarz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../v0.6.0/configuration/transports.html">v0.6.0</a></dd>
      <dd><a href="../../v0.5.0/configuration/transports.html">v0.5.0</a></dd>
      <dd><a href="../../v0.4.0/configuration/transports.html">v0.4.0</a></dd>
      <dd><a href="../../v0.3.1/configuration/transports.html">v0.3.1</a></dd>
      <dd><a href="../../v0.2.1/configuration/transports.html">v0.2.1</a></dd>
      <dd><a href="../../v0.1.1/configuration/transports.html">v0.1.1</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../configuration/transports.html">stable</a></dd>
      <dd><a href="transports.html">master</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>