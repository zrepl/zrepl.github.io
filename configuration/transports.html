

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Transports &mdash; zrepl  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/banner.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Filter Syntax" href="filter_syntax.html" />
    <link rel="prev" title="Job Types in Detail" href="jobs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> zrepl
          

          
            
            <img src="../_static/zrepl.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview &amp; Terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="jobs.html">Job Types in Detail</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Transports</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tcp-transport"><code class="docutils literal notranslate"><span class="pre">tcp</span></code> Transport</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#serve">Serve</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connect">Connect</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#tls-transport"><code class="docutils literal notranslate"><span class="pre">tls</span></code> Transport</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Serve</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Connect</a></li>
<li class="toctree-l4"><a class="reference internal" href="#self-signed-certificates">Self-Signed Certificates</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ssh-stdinserver-transport"><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> Transport</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#transport-ssh-stdinserver-serve">Serve</a></li>
<li class="toctree-l4"><a class="reference internal" href="#transport-ssh-stdinserver-connect">Connect</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#local-transport"><code class="docutils literal notranslate"><span class="pre">local</span></code> Transport</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="filter_syntax.html">Filter Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="snapshotting.html">Taking Snaphots</a></li>
<li class="toctree-l2"><a class="reference internal" href="prune.html">Pruning Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pr.html">Talks &amp; Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zrepl/zrepl">GitHub Repository &amp; Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supporters.html">Supporters</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zrepl</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../configuration.html">Configuration</a> &raquo;</li>
        
      <li>Transports</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/zrepl/zrepl/blob/v0.2.1/docs/configuration/transports.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  





<div class="section" id="transports">
<span id="transport"></span><h1><a class="toc-backref" href="#id6">Transports</a><a class="headerlink" href="#transports" title="Permalink to this headline">¶</a></h1>
<p>The zrepl RPC layer uses <strong>transports</strong> to establish a single, bidirectional data stream between an active and passive job.
On the passive (serving) side, the transport also provides the <strong>client identity</strong> to the upper layers:
this string is used for access control and separation of filesystem sub-trees in <a class="reference internal" href="jobs.html#job-sink"><span class="std std-ref">sink jobs</span></a>.
Transports are specified in the <code class="docutils literal notranslate"><span class="pre">connect</span></code> or <code class="docutils literal notranslate"><span class="pre">serve</span></code> section of a job definition.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#transports" id="id6">Transports</a><ul>
<li><a class="reference internal" href="#tcp-transport" id="id7"><code class="docutils literal notranslate"><span class="pre">tcp</span></code> Transport</a><ul>
<li><a class="reference internal" href="#serve" id="id8">Serve</a></li>
<li><a class="reference internal" href="#connect" id="id9">Connect</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tls-transport" id="id10"><code class="docutils literal notranslate"><span class="pre">tls</span></code> Transport</a><ul>
<li><a class="reference internal" href="#id1" id="id11">Serve</a></li>
<li><a class="reference internal" href="#id2" id="id12">Connect</a></li>
<li><a class="reference internal" href="#self-signed-certificates" id="id13">Self-Signed Certificates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ssh-stdinserver-transport" id="id14"><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> Transport</a><ul>
<li><a class="reference internal" href="#transport-ssh-stdinserver-serve" id="id15">Serve</a></li>
<li><a class="reference internal" href="#transport-ssh-stdinserver-connect" id="id16">Connect</a></li>
</ul>
</li>
<li><a class="reference internal" href="#local-transport" id="id17"><code class="docutils literal notranslate"><span class="pre">local</span></code> Transport</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">The <strong>client identities must be valid ZFS dataset path components</strong>
because the <a class="reference internal" href="jobs.html#job-sink"><span class="std std-ref">sink job</span></a> uses <code class="docutils literal notranslate"><span class="pre">${root_fs}/${client_identity}</span></code> to determine the client’s subtree.</p>
</div>
<div class="section" id="tcp-transport">
<span id="transport-tcp"></span><h2><a class="toc-backref" href="#id7"><code class="docutils literal notranslate"><span class="pre">tcp</span></code> Transport</a><a class="headerlink" href="#tcp-transport" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tcp</span></code> transport uses plain TCP, which means that the data is <strong>not encrypted</strong> on the wire.
Clients are identified by their IPv4 or IPv6 addresses, and the client identity is established through a mapping on the server.</p>
<p>This transport may also be used in conjunction with network-layer encryption and/or VPN tunnels to provide encryption on the wire.
To make the IP-based client authentication effective, such solutions should provide authenticated IP addresses.
Some options to consider:</p>
<ul class="simple" id="transport-tcp-tunneling">
<li><a class="reference external" href="https://www.wireguard.com/">WireGuard</a>: Linux-focussed, in-kernel TLS</li>
<li><a class="reference external" href="https://openvpn.net/">OpenVPN</a>: Cross-platform VPN, uses tun on *nix</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/IPsec">IPSec</a>: Properly standardized, in-kernel network-layer VPN</li>
<li><a class="reference external" href="http://www.tarsnap.com/spiped.html">spiped</a>: think of it as an encrypted pipe between two servers</li>
<li>SSH<ul>
<li><a class="reference external" href="https://sshuttle.readthedocs.io/en/stable/overview.html">sshuttle</a>: VPN-like solution, but using SSH</li>
<li><a class="reference external" href="https://help.ubuntu.com/community/SSH/OpenSSH/PortForwarding">SSH port forwarding</a>: Systemd user unit &amp; make it start before the zrepl service.</li>
</ul>
</li>
</ul>
<div class="section" id="serve">
<h3><a class="toc-backref" href="#id8">Serve</a><a class="headerlink" href="#serve" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
- type: sink
  serve:
    type: tcp
    listen: <span class="s2">&quot;:8888&quot;</span>
    clients: <span class="o">{</span>
      <span class="s2">&quot;192.168.122.123&quot;</span> : <span class="s2">&quot;mysql01&quot;</span>
      <span class="s2">&quot;192.168.122.123&quot;</span> : <span class="s2">&quot;mx01&quot;</span>
    <span class="o">}</span>
  ...
</pre></div>
</div>
</div>
<div class="section" id="connect">
<h3><a class="toc-backref" href="#id9">Connect</a><a class="headerlink" href="#connect" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
 - type: push
   connect:
     type: tcp
     address: <span class="s2">&quot;10.23.42.23:8888&quot;</span>
     dial_timeout: <span class="c1"># optional, default 10s</span>
   ...
</pre></div>
</div>
</div>
</div>
<div class="section" id="tls-transport">
<span id="transport-tcp-tlsclientauth"></span><h2><a class="toc-backref" href="#id10"><code class="docutils literal notranslate"><span class="pre">tls</span></code> Transport</a><a class="headerlink" href="#tls-transport" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tls</span></code> transport uses TCP + TLS with client authentication using client certificates.
The client identity is the common name (CN) presented in the client certificate.</p>
<p>It is recommended to set up a dedicated CA infrastructure for this transport, e.g. using OpenVPN’s <a class="reference external" href="https://github.com/OpenVPN/easy-rsa">EasyRSA</a>.
For a simple 2-machine setup, see the <a class="reference internal" href="#transport-tcp-tlsclientauth-2machineopenssl"><span class="std std-ref">instructions below</span></a>.</p>
<p>The implementation uses <a class="reference external" href="https://golang.org/pkg/crypto/tls/">Go’s TLS library</a>.
Since Go binaries are statically linked, you or your distribution need to recompile zrepl when vulnerabilities in that library are disclosed.</p>
<p>All file paths are resolved relative to the zrepl daemon’s working directory.
Specify absolute paths if you are unsure what directory that is (or find out from your init system).</p>
<p>If intermediate CAs are used, the <strong>full chain</strong> must be present in either in the <code class="docutils literal notranslate"><span class="pre">ca</span></code> file or the individual <code class="docutils literal notranslate"><span class="pre">cert</span></code> files.
Regardless, the client’s certificate must be first in the <code class="docutils literal notranslate"><span class="pre">cert</span></code> file, with each following certificate directly certifying the one preceding it (see <a class="reference external" href="https://tools.ietf.org/html/rfc5246#section-7.4.2">TLS’s specification</a>).
This is the common default when using a CA management tool.</p>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id11">Serve</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
  - type: sink
    root_fs: <span class="s2">&quot;pool2/backup_laptops&quot;</span>
    serve:
      type: tls
      listen: <span class="s2">&quot;:8888&quot;</span>
      ca:   /etc/zrepl/ca.crt
      cert: /etc/zrepl/prod.fullchain
      key:  /etc/zrepl/prod.key
      client_cns:
        - <span class="s2">&quot;laptop1&quot;</span>
        - <span class="s2">&quot;homeserver&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ca</span></code> field specified the certificate authority used to validate client certificates.
The <code class="docutils literal notranslate"><span class="pre">client_cns</span></code> list specifies a list of accepted client common names (which are also the client identities for this transport).</p>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id12">Connect</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
- type: pull
  connect:
    type: tls
    address: <span class="s2">&quot;server1.foo.bar:8888&quot;</span>
    ca:   /etc/zrepl/ca.crt
    cert: /etc/zrepl/backupserver.fullchain
    key:  /etc/zrepl/backupserver.key
    server_cn: <span class="s2">&quot;server1&quot;</span>
    dial_timeout: <span class="c1"># optional, default 10s</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ca</span></code> field specifies the CA which signed the server’s certificate (<code class="docutils literal notranslate"><span class="pre">serve.cert</span></code>).
The <code class="docutils literal notranslate"><span class="pre">server_cn</span></code> specifies the expected common name (CN) of the server’s certificate.
It overrides the hostname specified in <code class="docutils literal notranslate"><span class="pre">address</span></code>.
The connection fails if either do not match.</p>
</div>
<div class="section" id="self-signed-certificates">
<span id="transport-tcp-tlsclientauth-2machineopenssl"></span><h3><a class="toc-backref" href="#id13">Self-Signed Certificates</a><a class="headerlink" href="#self-signed-certificates" title="Permalink to this headline">¶</a></h3>
<p>Tools like <a class="reference external" href="https://github.com/OpenVPN/easy-rsa">EasyRSA</a> make it easy to manage CA infrastructure for multiple clients, e.g. a central zrepl backup server (in sink mode).
However, for a two-machine setup, self-signed certificates distributed using an out-of-band mechanism will also work just fine:</p>
<p>Suppose you have a push-mode setup, with <cite>backups.example.com</cite> running the <a class="reference internal" href="jobs.html#job-sink"><span class="std std-ref">sink job</span></a>, and <cite>prod.example.com</cite> running the <a class="reference internal" href="jobs.html#job-push"><span class="std std-ref">push job</span></a>.
Run the following OpenSSL commands on each host, substituting HOSTNAME in both filenames and the interactive input prompt by OpenSSL:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="hll">openssl req -x509 -sha256 -nodes <span class="se">\</span>
</span><span class="hll">   -newkey rsa:4096 <span class="se">\</span>
</span><span class="hll">   -days <span class="m">365</span> <span class="se">\</span>
</span><span class="hll">   -keyout HOSTNAME.key <span class="se">\</span>
</span><span class="hll">   -out HOSTNAME.crt
</span>
<span class="c1">#Generating a 4096 bit RSA private key</span>
<span class="c1">#................++++</span>
<span class="c1">#.++++</span>
<span class="c1">#writing new private key to &#39;backups.key&#39;</span>
<span class="c1">#-----</span>
<span class="c1">#You are about to be asked to enter information that will be incorporated</span>
<span class="c1">#into your certificate request.</span>
<span class="c1">#What you are about to enter is what is called a Distinguished Name or a DN.</span>
<span class="c1">#There are quite a few fields but you can leave some blank</span>
<span class="c1">#For some fields there will be a default value,</span>
<span class="c1">#If you enter &#39;.&#39;, the field will be left blank.</span>
<span class="c1">#-----</span>
<span class="c1">#Country Name (2 letter code) [XX]:</span>
<span class="c1">#State or Province Name (full name) []:</span>
<span class="c1">#Locality Name (eg, city) [Default City]:</span>
<span class="c1">#Organization Name (eg, company) [Default Company Ltd]:</span>
<span class="c1">#Organizational Unit Name (eg, section) []:</span>
<span class="hll"><span class="c1">#Common Name (eg, your name or your server&#39;s hostname) []:HOSTNAME</span>
</span><span class="c1">#Email Address []:</span>
</pre></div>
</div>
<p>Now copy each machine’s <code class="docutils literal notranslate"><span class="pre">HOSTNAME.crt</span></code> to the other machine’s <code class="docutils literal notranslate"><span class="pre">/etc/zrepl/HOSTNAME.crt</span></code>, for example using <cite>scp</cite>.
The serve &amp; connect configuration will thus look like the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># on backups.example.com</span>
- type: sink
  serve:
    type: tls
    listen: <span class="s2">&quot;:8888&quot;</span>
    ca: <span class="s2">&quot;/etc/zrepl/prod.example.com.crt&quot;</span>
    cert: <span class="s2">&quot;/etc/zrepl/backups.example.com.crt&quot;</span>
    key: <span class="s2">&quot;/etc/zrepl/backups.example.com.key&quot;</span>
    client_cns:
      - <span class="s2">&quot;prod.example.com&quot;</span>
  ...

<span class="c1"># on prod.example.com</span>
- type: push
  connect:
    type: tls
    address:<span class="s2">&quot;backups.example.com:8888&quot;</span>
    ca: /etc/zrepl/backups.example.com.crt
    cert: /etc/zrepl/prod.example.com.crt
    key:  /etc/zrepl/prod.example.com.key
    server_cn: <span class="s2">&quot;backups.example.com&quot;</span>
  ...
</pre></div>
</div>
</div>
</div>
<div class="section" id="ssh-stdinserver-transport">
<span id="transport-ssh-stdinserver"></span><h2><a class="toc-backref" href="#id14"><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> Transport</a><a class="headerlink" href="#ssh-stdinserver-transport" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> uses the <code class="docutils literal notranslate"><span class="pre">ssh</span></code> command and some features of the server-side SSH <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file.
It is less efficient than other transports because the data passes through two more pipes.
However, it is fairly convenient to set up and allows the zrepl daemon to not be directly exposed to the internet, because all traffic passes through the system’s SSH server.</p>
<p>The concept is inspired by <a class="reference external" href="https://git-scm.com/docs/git-shell">git shell</a> and <a class="reference external" href="https://borgbackup.readthedocs.io/en/stable/deployment.html">Borg Backup</a>.
The implementation is provided by the Go package <code class="docutils literal notranslate"><span class="pre">github.com/problame/go-netssh</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> generally provides inferior error detection and handling compared to the <code class="docutils literal notranslate"><span class="pre">tcp</span></code> and <code class="docutils literal notranslate"><span class="pre">tls</span></code> transports.
When encountering such problems, consider using  <code class="docutils literal notranslate"><span class="pre">tcp</span></code> or <code class="docutils literal notranslate"><span class="pre">tls</span></code> transports, or help improve package go-netssh.</p>
</div>
<div class="section" id="transport-ssh-stdinserver-serve">
<span id="id4"></span><h3><a class="toc-backref" href="#id15">Serve</a><a class="headerlink" href="#transport-ssh-stdinserver-serve" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
- type: <span class="nb">source</span>
  serve:
    type: stdinserver
    client_identities:
    - <span class="s2">&quot;client1&quot;</span>
    - <span class="s2">&quot;client2&quot;</span>
  ...
</pre></div>
</div>
<p>First of all, note that <code class="docutils literal notranslate"><span class="pre">type=stdinserver</span></code> in this case:
Currently, only <code class="docutils literal notranslate"><span class="pre">connect.type=ssh+stdinserver</span></code> can connect to a <code class="docutils literal notranslate"><span class="pre">serve.type=stdinserver</span></code>, but we want to keep that option open for future extensions.</p>
<p>The serving job opens a UNIX socket named after <code class="docutils literal notranslate"><span class="pre">client_identity</span></code> in the runtime directory.
In our example above, that is <code class="docutils literal notranslate"><span class="pre">/var/run/zrepl/stdinserver/client1</span></code> and <code class="docutils literal notranslate"><span class="pre">/var/run/zrepl/stdinserver/client2</span></code>.</p>
<p>On the same machine, the <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">stdinserver</span> <span class="pre">$client_identity</span></code> command connects to <code class="docutils literal notranslate"><span class="pre">/var/run/zrepl/stdinserver/$client_identity</span></code>.
It then passes its stdin and stdout file descriptors to the zrepl daemon via <em>cmsg(3)</em>.
zrepl daemon in turn combines them into an object implementing <code class="docutils literal notranslate"><span class="pre">net.Conn</span></code>:
a <code class="docutils literal notranslate"><span class="pre">Write()</span></code> turns into a write to stdout, a <code class="docutils literal notranslate"><span class="pre">Read()</span></code> turns into a read from stdin.</p>
<p>Interactive use of the <code class="docutils literal notranslate"><span class="pre">stdinserver</span></code> subcommand does not make much sense.
However, we can force its execution when a user with a particular SSH pubkey connects via SSH.
This can be achieved with an entry in the <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file of the serving zrepl daemon.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># for OpenSSH &gt;= 7.2</span>
<span class="nv">command</span><span class="o">=</span><span class="s2">&quot;zrepl stdinserver CLIENT_IDENTITY&quot;</span>,restrict CLIENT_SSH_KEY
<span class="c1"># for older OpenSSH versions</span>
<span class="nv">command</span><span class="o">=</span><span class="s2">&quot;zrepl stdinserver CLIENT_IDENTITY&quot;</span>,no-port-forwarding,no-X11-forwarding,no-pty,no-agent-forwarding,no-user-rc CLIENT_SSH_KEY
</pre></div>
</div>
<ul class="simple">
<li>CLIENT_IDENTITY is substituted with an entry from <code class="docutils literal notranslate"><span class="pre">client_identities</span></code> in our example</li>
<li>CLIENT_SSH_KEY is substituted with the public part of the SSH keypair specified in the <code class="docutils literal notranslate"><span class="pre">connect.identity_file</span></code> directive on the connecting host.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You may need to adjust the <code class="docutils literal notranslate"><span class="pre">PermitRootLogin</span></code> option in <code class="docutils literal notranslate"><span class="pre">/etc/ssh/sshd_config</span></code> to <code class="docutils literal notranslate"><span class="pre">forced-commands-only</span></code> or higher for this to work.
Refer to sshd_config(5) for details.</p>
</div>
<p>To recap, this is of how client authentication works with the <code class="docutils literal notranslate"><span class="pre">ssh+stdinserver</span></code> transport:</p>
<ul class="simple">
<li>Connections to the <code class="docutils literal notranslate"><span class="pre">/var/run/zrepl/stdinserver/${client_identity}</span></code> UNIX socket are blindly trusted by zrepl daemon.
The connection client identity is the name of the socket, i.e. <code class="docutils literal notranslate"><span class="pre">${client_identity}</span></code>.</li>
<li>Thus, the runtime directory must be private to the zrepl user (this is checked by zrepl daemon)</li>
<li>The admin of the host with the serving zrepl daemon controls the <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file.</li>
<li>Thus, the administrator controls the mapping <code class="docutils literal notranslate"><span class="pre">PUBKEY</span> <span class="pre">-&gt;</span> <span class="pre">CLIENT_IDENTITY</span></code>.</li>
</ul>
</div>
<div class="section" id="transport-ssh-stdinserver-connect">
<span id="id5"></span><h3><a class="toc-backref" href="#id16">Connect</a><a class="headerlink" href="#transport-ssh-stdinserver-connect" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
- type: pull
  connect:
    type: ssh+stdinserver
    host: prod.example.com
    user: root
    port: <span class="m">22</span>
    identity_file: /etc/zrepl/ssh/identity
    <span class="c1"># options: # optional, default [], `-o` arguments passed to ssh</span>
    <span class="c1"># - &quot;Compression=yes&quot;</span>
    <span class="c1"># dial_timeout: 10s # optional, default 10s, max time.Duration until initial handshake is completed</span>
</pre></div>
</div>
<p>The connecting zrepl daemon</p>
<ol class="arabic simple">
<li>Creates a pipe</li>
<li>Forks</li>
<li>In the forked process<ol class="arabic">
<li>Replaces forked stdin and stdout with the corresponding pipe ends</li>
<li>Executes the <code class="docutils literal notranslate"><span class="pre">ssh</span></code> binary found in <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>.<ol class="arabic">
<li>The identity file (<code class="docutils literal notranslate"><span class="pre">-i</span></code>) is set to <code class="docutils literal notranslate"><span class="pre">$identity_file</span></code>.</li>
<li>The remote user, host and port correspond to those configured.</li>
<li>Further options can be specified using the <code class="docutils literal notranslate"><span class="pre">options</span></code> field, which appends each entry in the list to the command line using <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">$entry</span></code>.</li>
</ol>
</li>
</ol>
</li>
<li>Wraps the pipe ends in a <code class="docutils literal notranslate"><span class="pre">net.Conn</span></code> and returns it to the RPC layer.</li>
</ol>
<p>As discussed in the section above, the connecting zrepl daemon expects that <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">stdinserver</span> <span class="pre">$client_identity</span></code> is  executed automatically via an <code class="docutils literal notranslate"><span class="pre">authorized_keys</span></code> file entry.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">known_hosts</span></code> file used by the ssh command must contain an entry for <code class="docutils literal notranslate"><span class="pre">connect.host</span></code> prior to starting zrepl.
Thus, run the following on the pulling host’s command line (substituting <code class="docutils literal notranslate"><span class="pre">connect.host</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh -i /etc/zrepl/ssh/identity root@prod.example.com
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The environment variables of the underlying SSH process are cleared. <code class="docutils literal notranslate"><span class="pre">$SSH_AUTH_SOCK</span></code> will not be available.
It is suggested to create a separate, unencrypted SSH key solely for that purpose.</p>
</div>
</div>
</div>
<div class="section" id="local-transport">
<span id="transport-local"></span><h2><a class="toc-backref" href="#id17"><code class="docutils literal notranslate"><span class="pre">local</span></code> Transport</a><a class="headerlink" href="#local-transport" title="Permalink to this headline">¶</a></h2>
<p>The local transport can be used to implement <a class="reference internal" href="jobs.html#replication-local"><span class="std std-ref">local replication</span></a>, i.e., push replication between a push and sink job defined in the same configuration file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">listener_name</span></code> is analogous to a hostname and must match between <code class="docutils literal notranslate"><span class="pre">serve</span></code> and <code class="docutils literal notranslate"><span class="pre">connect</span></code>.
The <code class="docutils literal notranslate"><span class="pre">client_identity</span></code> is used by the sink as documented above.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jobs:
- type: sink
  serve:
    type: <span class="nb">local</span>
    listener_name: localsink
  ...

- type: push
  connect:
    type: <span class="nb">local</span>
    listener_name: localsink
    client_identity: local_backup
    dial_timeout: 2s <span class="c1"># optional, 0 for no timeout</span>
  ...
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="filter_syntax.html" class="btn btn-neutral float-right" title="Filter Syntax" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="jobs.html" class="btn btn-neutral float-left" title="Job Types in Detail" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Christian Schwarz

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: v0.2.1
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../v0.3.0-rc2/configuration/transports.html">v0.3.0-rc2</a></dd>
            <dd><a href="../v0.2.1/configuration/transports.html">v0.2.1</a></dd>
            <dd><a href="../v0.1.1/configuration/transports.html">v0.1.1</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../master/configuration/transports.html">master</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>