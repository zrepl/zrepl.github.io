<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overview &amp; Terminology &mdash; zrepl latest documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/banner.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=c6e86fd7"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Job Types in Detail" href="jobs.html" />
    <link rel="prev" title="Configuration" href="../configuration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            zrepl
              <img src="../_static/zrepl.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                latest
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start by Use Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Overview &amp; Terminology</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#config-file-structure">Config File Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#conf-d-including-config-files"><code class="docutils literal notranslate"><span class="pre">conf.d</span></code>: including config files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#jobs-how-they-work-together">Jobs &amp; How They Work Together</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-the-active-side-works">How the Active Side Works</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-the-passive-side-works">How the Passive Side Works</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-replication-works">How Replication Works</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#zfs-background-knowledge">ZFS Background Knowledge</a></li>
<li class="toctree-l4"><a class="reference internal" href="#zfs-abstractions-managed-by-zrepl">ZFS Abstractions Managed By zrepl</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#caveats-with-complex-setups-more-than-2-jobs-or-machines">Caveats With Complex Setups (More Than 2 Jobs or Machines)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#multiple-jobs-on-one-machine">Multiple Jobs on One Machine</a></li>
<li class="toctree-l4"><a class="reference internal" href="#two-or-more-machines">Two Or More Machines</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="jobs.html">Job Types in Detail</a></li>
<li class="toctree-l2"><a class="reference internal" href="transports.html">Transports</a></li>
<li class="toctree-l2"><a class="reference internal" href="filter_syntax.html">Filter Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="sendrecvoptions.html">Send &amp; Recv Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="replication.html">Replication Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="conflict_resolution.html">Conflict Resolution Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="snapshotting.html">Taking Snaphots</a></li>
<li class="toctree-l2"><a class="reference internal" href="prune.html">Pruning Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pr.html">Talks &amp; Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../future.html">Future</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zrepl/zrepl">GitHub Repository &amp; Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://matrix.to/#/#zrepl:matrix.org">Chat: Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supporters.html">Supporters</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zrepl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../configuration.html">Configuration</a></li>
      <li class="breadcrumb-item active">Overview &amp; Terminology</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/zrepl/zrepl/blob/master/docs/configuration/overview.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="overview-terminology">
<h1>Overview &amp; Terminology<a class="headerlink" href="#overview-terminology" title="Link to this heading"></a></h1>
<p>All work zrepl does is performed by the zrepl daemon which is configured in a single YAML configuration file loaded on startup.
The following paths are searched, in this order:</p>
<ol class="arabic simple">
<li><p>The path specified via the global <code class="docutils literal notranslate"><span class="pre">--config</span></code> flag</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/zrepl/zrepl.yml</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/usr/local/etc/zrepl/zrepl.yml</span></code></p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">configcheck</span></code> can be used to validate the configuration.
If the configuration is valid, it will output nothing and exit with code <code class="docutils literal notranslate"><span class="pre">0</span></code>.
The error messages vary in quality and usefulness: please report confusing config errors to the tracking <a class="reference external" href="https://github.com/zrepl/zrepl/issues/155">issue #155</a>.</p>
<p>Full example configs are available at <a class="reference internal" href="../quickstart.html#quickstart-toc"><span class="std std-ref">quick-start guides</span></a> and <a class="reference external" href="https://github.com/zrepl/zrepl/blob/master/internal/config/samples/">internal/config/samples/</a>.
However, copy-pasting examples is no substitute for reading documentation!</p>
<section id="config-file-structure">
<h2>Config File Structure<a class="headerlink" href="#config-file-structure" title="Link to this heading"></a></h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">global</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backup</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">push</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
<p>A zrepl configuration file is divided in to two main sections: <code class="docutils literal notranslate"><span class="pre">global</span></code> and <code class="docutils literal notranslate"><span class="pre">jobs</span></code>.
<code class="docutils literal notranslate"><span class="pre">global</span></code> has sensible defaults. It is covered in <a class="reference internal" href="logging.html#logging"><span class="std std-ref">logging</span></a>, <a class="reference internal" href="monitoring.html#monitoring"><span class="std std-ref">monitoring</span></a> &amp; <a class="reference internal" href="misc.html#miscellaneous"><span class="std std-ref">miscellaneous</span></a>.</p>
<section id="conf-d-including-config-files">
<h3><code class="docutils literal notranslate"><span class="pre">conf.d</span></code>: including config files<a class="headerlink" href="#conf-d-including-config-files" title="Link to this heading"></a></h3>
<p>It is possible to distribute zrepl configurations over multiple YAML configuration
files. This is achieved by using the <cite>include</cite> key which can only exist in the main
configuration file.</p>
<p>The list of included paths must point to either individual YAML files or directories.
If the path points to a directory then all YAML files with a <cite>.yml</cite> extention in the
directory will be included.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/zrepl/zrep.yml</span>
<span class="nt">global</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">include</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./jobs.d/</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/some_job.yml</span>

<span class="c1"># /etc/zrepl/jobs.d/backup.yml</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backup</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">push</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="c1"># /opt/some_job.yml</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">another_job</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
<p>The paths are treated as absolute when starting with <cite>/</cite>, otherwise
as a relative path to the main config file’s parent directory.</p>
<p>Job names must be unique across all included configuration files.</p>
</section>
</section>
<section id="jobs-how-they-work-together">
<span id="job-overview"></span><h2>Jobs &amp; How They Work Together<a class="headerlink" href="#jobs-how-they-work-together" title="Link to this heading"></a></h2>
<p>A <em>job</em> is the unit of activity tracked by the zrepl daemon.
The <code class="docutils literal notranslate"><span class="pre">type</span></code> of a job determines its role in a replication setup and in snapshot management.
Jobs are identified by their <code class="docutils literal notranslate"><span class="pre">name</span></code>, both in log files and the <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">status</span></code> command.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The job name is persisted in several places on disk and thus <a class="reference external" href="https://github.com/zrepl/zrepl/issues/327">cannot be changed easily</a>.</p>
</div>
<p>Replication always happens between a pair of jobs: one <strong>active side</strong> and one <strong>passive side</strong>.
The active side connects to the passive side using a <a class="reference internal" href="transports.html#transport"><span class="std std-ref">transport</span></a> and starts executing the replication logic.
The passive side responds to requests from the active side after checking its permissions.</p>
<p>The following table shows how different job types can be combined to achieve <strong>both push and pull mode setups</strong>.
Note that snapshot-creation denoted by “(snap)” is orthogonal to whether a job is active or passive.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Setup name</p></th>
<th class="head"><p>active side</p></th>
<th class="head"><p>passive side</p></th>
<th class="head"><p>use case</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Push mode</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">push</span></code>
(snap)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sink</span></code></p></td>
<td><ul class="simple">
<li><p>Laptop backup</p></li>
<li><p>NAS behind NAT to offsite</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>Pull mode</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pull</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">source</span></code>
(snap)</p></td>
<td><ul class="simple">
<li><p>Central backup-server for many nodes</p></li>
<li><p>Remote server to NAS behind NAT</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>Local replication</p></td>
<td colspan="2"><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">push</span></code> + <code class="docutils literal notranslate"><span class="pre">sink</span></code> in one config</div>
<div class="line">with <a class="reference internal" href="transports.html#transport-local"><span class="std std-ref">local transport</span></a></div>
</div>
</td>
<td><ul class="simple">
<li><p>Backup to <a class="reference internal" href="../quickstart/backup_to_external_disk.html#quickstart-backup-to-external-disk"><span class="std std-ref">locally attached disk</span></a></p></li>
<li><p>Backup FreeBSD boot pool</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>Snap &amp; prune-only</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">snap</span></code>
(snap)</p></td>
<td><p>N/A</p></td>
<td><ul>
<li><div class="line-block">
<div class="line">Snapshots &amp; pruning but no replication</div>
<div class="line">required</div>
</div>
</li>
<li><p>Workaround for <a class="reference internal" href="prune.html#prune-workaround-source-side-pruning"><span class="std std-ref">source-side pruning</span></a></p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</section>
<section id="how-the-active-side-works">
<h2>How the Active Side Works<a class="headerlink" href="#how-the-active-side-works" title="Link to this heading"></a></h2>
<p>The active side (<a class="reference internal" href="jobs.html#job-push"><span class="std std-ref">push</span></a> and <a class="reference internal" href="jobs.html#job-pull"><span class="std std-ref">pull</span></a> job) executes the replication and pruning logic:</p>
<ol class="arabic simple">
<li><p>Wakeup after snapshotting (<code class="docutils literal notranslate"><span class="pre">push</span></code> job) or pull interval ticker (<code class="docutils literal notranslate"><span class="pre">pull</span></code> job).</p></li>
<li><p>Connect to the passive side and instantiate an RPC client.</p></li>
<li><p>Replicate data from the sender to the receiver.</p></li>
<li><p>Prune on sender &amp; receiver.</p></li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The progress of the active side can be watched live using <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">status</span></code>.</p>
</div>
</section>
<section id="how-the-passive-side-works">
<span id="overview-passive-side-client-identity"></span><h2>How the Passive Side Works<a class="headerlink" href="#how-the-passive-side-works" title="Link to this heading"></a></h2>
<p>The passive side (<a class="reference internal" href="jobs.html#job-sink"><span class="std std-ref">sink</span></a> and <a class="reference internal" href="jobs.html#job-source"><span class="std std-ref">source</span></a>) waits for connections from the active side,
on the <a class="reference internal" href="transports.html#transport"><span class="std std-ref">transport</span></a> specified with <code class="docutils literal notranslate"><span class="pre">serve</span></code> in the job configuration.
The respective transport then perfoms authentication &amp; authorization, resulting in a stable <em>client identity</em>.
The passive side job uses this <em>client identity</em> as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">sink</span></code> jobs, to map requests from different <em>client identities</em> to their respective sub-filesystem tree <code class="docutils literal notranslate"><span class="pre">root_fs/${client_identity}</span></code>.</p></li>
<li><p><em>In the future, ``source`` might embed the client identity in :ref:`zrepl’s ZFS abstraction names &lt;zrepl-zfs-abstractions&gt;`, to support multi-host replication.</em></p></li>
</ul>
</div></blockquote>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The use of the client identity in the <code class="docutils literal notranslate"><span class="pre">sink</span></code> job implies that it must be usable as a ZFS ZFS filesystem name component.</p>
</div>
</section>
<section id="how-replication-works">
<span id="overview-how-replication-works"></span><h2>How Replication Works<a class="headerlink" href="#how-replication-works" title="Link to this heading"></a></h2>
<p>One of the major design goals of the replication module is to avoid any duplication of the nontrivial logic.
As such, the code works on abstract senders and receiver <strong>endpoints</strong>, where typically one will be implemented by a local program object and the other is an RPC client instance.
Regardless of push- or pull-style setup, the logic executes on the active side, i.e. in the <code class="docutils literal notranslate"><span class="pre">push</span></code> or <code class="docutils literal notranslate"><span class="pre">pull</span></code> job.</p>
<p>The following high-level steps take place during replication and can be monitored using <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">status</span></code>:</p>
<ul class="simple">
<li><p>Plan the replication:</p>
<ul>
<li><p>Compare sender and receiver filesystem snapshots</p></li>
<li><p>Build the <strong>replication plan</strong></p>
<ul>
<li><p>Per filesystem, compute a diff between sender and receiver snapshots</p></li>
<li><p>Build a list of <strong>replication steps</strong></p>
<ul>
<li><p>If possible, use incremental and resumable sends</p></li>
<li><p>Otherwise, use full send of most recent snapshot on sender</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Retry on errors that are likely temporary (i.e. network failures).</p></li>
<li><p>Give up on filesystems where a permanent error was received over RPC.</p></li>
</ul>
</li>
<li><p>Execute the plan</p>
<ul>
<li><p>Perform replication steps in the following order:
Among all filesystems with pending replication steps, pick the filesystem whose next replication step’s snapshot is the oldest.</p></li>
<li><p>Create placeholder filesystems on the receiving side to mirror the dataset paths on the sender to <code class="docutils literal notranslate"><span class="pre">root_fs/${client_identity}</span></code>.</p></li>
<li><p>Acquire send-side <em>step-holds</em> on the step’s <cite>from</cite> and <cite>to</cite> snapshots.</p></li>
<li><p>Perform the replication step.</p></li>
<li><p>Move the <strong>replication cursor</strong> bookmark on the sending side (see below).</p></li>
<li><p>Move the <strong>last-received-hold</strong> on the receiving side (see below).</p></li>
<li><p>Release the send-side step-holds.</p></li>
</ul>
</li>
</ul>
<p>The idea behind the execution order of replication steps is that if the sender snapshots all filesystems simultaneously at fixed intervals, the receiver will have all filesystems snapshotted at time <code class="docutils literal notranslate"><span class="pre">T1</span></code> before the first snapshot at <code class="docutils literal notranslate"><span class="pre">T2</span> <span class="pre">=</span> <span class="pre">T1</span> <span class="pre">+</span> <span class="pre">$interval</span></code> is replicated.</p>
<section id="zfs-background-knowledge">
<h3>ZFS Background Knowledge<a class="headerlink" href="#zfs-background-knowledge" title="Link to this heading"></a></h3>
<p>This section gives some background knowledge about ZFS features that zrepl uses to provide guarantees for a replication filesystem.
Specifically, zrepl guarantees by default that <strong>incremental replication is always possible and that started replication steps can always be resumed if they are interrupted.</strong></p>
<p><strong>ZFS Send Modes &amp; Bookmarks</strong>
ZFS supports full sends (<code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span> <span class="pre">fs&#64;to</span></code>) and incremental sends (<code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span> <span class="pre">-i</span> <span class="pre">&#64;from</span> <span class="pre">fs&#64;to</span></code>).
Full sends are used to create a new filesystem on the receiver with the send-side state of <code class="docutils literal notranslate"><span class="pre">fs&#64;to</span></code>.
Incremental sends only transfer the delta between <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;to</span></code>.
Incremental sends require that <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code> be present on the receiving side when receiving the incremental stream.
Incremental sends can also use a ZFS bookmark as <em>from</em> on the sending side (<code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span> <span class="pre">-i</span> <span class="pre">#bm_from</span> <span class="pre">fs&#64;to</span></code>), where <code class="docutils literal notranslate"><span class="pre">#bm_from</span></code> was created using <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">bookmark</span> <span class="pre">fs&#64;from</span> <span class="pre">fs#bm_from</span></code>.
The receiving side must always have the actual snapshot <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code>, regardless of whether the sending side uses <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code> or a bookmark of it.</p>
<p id="zfs-background-knowledge-plain-vs-raw-sends"><strong>Plain and raw sends</strong>
By default, <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span></code> sends the most generic, backwards-compatible data stream format (so-called ‘plain send’).
If the sent uses newer features, e.g. compression or encryption, <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span></code> has to un-do these operations on the fly to produce the plain send stream.
If the receiver uses newer features (e.g. compression or encryption inherited from the parent FS), it applies the necessary transformations again on the fly during <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">recv</span></code>.</p>
<p>Flags such as <code class="docutils literal notranslate"><span class="pre">-e</span></code>, <code class="docutils literal notranslate"><span class="pre">-c</span></code> and <code class="docutils literal notranslate"><span class="pre">-L</span></code>  tell ZFS to produce a send stream that is closer to how the data is stored on disk.
Sending with those flags removes computational overhead from sender and receiver.
However, the receiver will not apply certain transformations, e.g., it will not compress with the receive-side <code class="docutils literal notranslate"><span class="pre">compression</span></code> algorithm.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-w</span></code> (<code class="docutils literal notranslate"><span class="pre">--raw</span></code>) flag produces a send stream that is as <em>raw</em> as possible.
For unencrypted datasets, its current effect is the same as <code class="docutils literal notranslate"><span class="pre">-Lce</span></code>.</p>
<p>Encrypted datasets can only be sent plain (unencrypted) or raw (encrypted) using the <code class="docutils literal notranslate"><span class="pre">-w</span></code> flag.</p>
<p><strong>Resumable Send &amp; Recv</strong>
The <code class="docutils literal notranslate"><span class="pre">-s</span></code> flag for <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">recv</span></code> tells zfs to save the partially received send stream in case it is interrupted.
To resume the replication, the receiving side filesystem’s <code class="docutils literal notranslate"><span class="pre">receive_resume_token</span></code> must be passed to a new <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span> <span class="pre">-t</span> <span class="pre">&lt;value&gt;</span> <span class="pre">|</span> <span class="pre">zfs</span> <span class="pre">recv</span></code> command.
A full send can only be resumed if <code class="docutils literal notranslate"><span class="pre">&#64;to</span></code> still exists.
An incremental send can only be resumed if <code class="docutils literal notranslate"><span class="pre">&#64;to</span></code> still exists <em>and</em> either <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code> still exists <em>or</em> a bookmark <code class="docutils literal notranslate"><span class="pre">#fbm</span></code> of <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code> still exists.</p>
<p><strong>ZFS Holds</strong>
ZFS holds prevent a snapshot from being deleted through <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">destroy</span></code>, letting the destroy fail with a <code class="docutils literal notranslate"><span class="pre">datset</span> <span class="pre">is</span> <span class="pre">busy</span></code> error.
Holds are created and referred to by a <em>tag</em>. They can be thought of as a named, persistent lock on the snapshot.</p>
</section>
<section id="zfs-abstractions-managed-by-zrepl">
<span id="zrepl-zfs-abstractions"></span><h3>ZFS Abstractions Managed By zrepl<a class="headerlink" href="#zfs-abstractions-managed-by-zrepl" title="Link to this heading"></a></h3>
<p>With the background knowledge from the previous paragraph, we now summarize the different on-disk ZFS objects that zrepl manages to provide its functionality.</p>
<p id="replication-placeholder-property"><strong>Placeholder filesystems</strong> on the receiving side are regular ZFS filesystems with the ZFS property <code class="docutils literal notranslate"><span class="pre">zrepl:placeholder=on</span></code>.
Placeholders allow the receiving side to mirror the sender’s ZFS dataset hierarchy without replicating every filesystem at every intermediary dataset path component.
Consider the following example: <code class="docutils literal notranslate"><span class="pre">S/H/J</span></code> shall be replicated to <code class="docutils literal notranslate"><span class="pre">R/sink/job/S/H/J</span></code>, but neither <code class="docutils literal notranslate"><span class="pre">S/H</span></code> nor <code class="docutils literal notranslate"><span class="pre">S</span></code> shall be replicated.
ZFS requires the existence of <code class="docutils literal notranslate"><span class="pre">R/sink/job/S</span></code> and <code class="docutils literal notranslate"><span class="pre">R/sink/job/S/H</span></code> in order to receive into <code class="docutils literal notranslate"><span class="pre">R/sink/job/S/H/J</span></code>.
Thus, zrepl creates the parent filesystems as placeholders on the receiving side.
If at some point <code class="docutils literal notranslate"><span class="pre">S/H</span></code> and <code class="docutils literal notranslate"><span class="pre">S</span></code> shall be replicated, the receiving side invalidates the placeholder flag automatically.
The <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">test</span> <span class="pre">placeholder</span></code> command can be used to check whether a filesystem is a placeholder.</p>
<p id="replication-cursor-and-last-received-hold">The <strong>replication cursor</strong> bookmark and <strong>last-received-hold</strong> are managed by zrepl to ensure that future replications can always be done incrementally.
The replication cursor is a send-side bookmark of the most recent successfully replicated snapshot,
and the last-received-hold is a hold of that snapshot on the receiving side.
Both are moved atomically after the receiving side has confirmed that a replication step is complete.</p>
<p>The replication cursor has the format <code class="docutils literal notranslate"><span class="pre">#zrepl_CUSOR_G_&lt;GUID&gt;_J_&lt;JOBNAME&gt;</span></code>.
The last-received-hold tag has the format <code class="docutils literal notranslate"><span class="pre">zrepl_last_received_J_&lt;JOBNAME&gt;</span></code>.
Encoding the job name in the names ensures that multiple sending jobs can replicate the same filesystem to different receivers without interference.</p>
<p id="tentative-replication-cursor-bookmarks"><strong>Tentative replication cursor bookmarks</strong> are short-lived bookmarks that protect the atomic moving-forward of the replication cursor and last-received-hold (see <a class="reference external" href="https://github.com/zrepl/zrepl/issues/340">this issue</a>).
They are only necessary if step holds are not used as per the <a class="reference internal" href="replication.html#replication-option-protection"><span class="std std-ref">replication.protection</span></a> setting.
The tentative replication cursor has the format <code class="docutils literal notranslate"><span class="pre">#zrepl_CUSORTENTATIVE_G_&lt;GUID&gt;_J_&lt;JOBNAME&gt;</span></code>.
The <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">zfs-abstraction</span> <span class="pre">list</span></code> command provides a listing of all bookmarks and holds managed by zrepl.</p>
<p id="step-holds"><strong>Step holds</strong> are zfs holds managed by zrepl to ensure that a replication step can always be resumed if it is interrupted, e.g., due to network outage.
zrepl creates step holds before it attempts a replication step and releases them after the receiver confirms that the replication step is complete.
For an initial replication <code class="docutils literal notranslate"><span class="pre">full</span> <span class="pre">&#64;initial_snap</span></code>, zrepl puts a zfs hold on <code class="docutils literal notranslate"><span class="pre">&#64;initial_snap</span></code>.
For an incremental send <code class="docutils literal notranslate"><span class="pre">&#64;from</span> <span class="pre">-&gt;</span> <span class="pre">&#64;to</span></code>, zrepl puts a zfs hold on both <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;to</span></code>.
Note that <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code> is not strictly necessary for resumability – a bookmark on the sending side would be sufficient –, but size-estimation in currently used OpenZFS versions only works if <code class="docutils literal notranslate"><span class="pre">&#64;from</span></code> is a snapshot.
The hold tag has the format <code class="docutils literal notranslate"><span class="pre">zrepl_STEP_J_&lt;JOBNAME&gt;</span></code>.
A job only ever has one active send per filesystem.
Thus, there are never more than two step holds for a given pair of <code class="docutils literal notranslate"><span class="pre">(job,filesystem)</span></code>.</p>
<p><strong>Step bookmarks</strong> are zrepl’s equivalent for holds on bookmarks (ZFS does not support putting holds on bookmarks).
They are intended for a situation where a replication step uses a bookmark <code class="docutils literal notranslate"><span class="pre">#bm</span></code> as incremental <code class="docutils literal notranslate"><span class="pre">from</span></code> where <code class="docutils literal notranslate"><span class="pre">#bm</span></code> is not managed by zrepl.
To ensure resumability, zrepl copies <code class="docutils literal notranslate"><span class="pre">#bm</span></code> to step bookmark <code class="docutils literal notranslate"><span class="pre">#zrepl_STEP_G_&lt;GUID&gt;_J_&lt;JOBNAME&gt;</span></code>.
If the replication is interrupted and <code class="docutils literal notranslate"><span class="pre">#bm</span></code> is deleted by the user, the step bookmark remains as an incremental source for the resumable send.
Note that zrepl does not yet support creating step bookmarks because the <a class="reference external" href="https://github.com/openzfs/zfs/pull/9571">corresponding ZFS feature for copying bookmarks</a> is not yet widely available .
Subscribe to zrepl <a class="reference external" href="https://github.com/zrepl/zrepl/issues/326">issue #326</a> for details.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">zfs-abstraction</span> <span class="pre">list</span></code> command provides a listing of all bookmarks and holds managed by zrepl.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>More details can be found in the design document <a class="reference external" href="https://github.com/zrepl/zrepl/blob/master/replication/design.md">replication/design.md</a>.</p>
</div>
</section>
</section>
<section id="caveats-with-complex-setups-more-than-2-jobs-or-machines">
<h2>Caveats With Complex Setups (More Than 2 Jobs or Machines)<a class="headerlink" href="#caveats-with-complex-setups-more-than-2-jobs-or-machines" title="Link to this heading"></a></h2>
<p>Most users are served well with a single sender and a single receiver job.
This section documents considerations for more complex setups.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Before you continue, make sure you have a working understanding of <a class="reference internal" href="#overview-how-replication-works"><span class="std std-ref">how zrepl works</span></a>
and <a class="reference internal" href="#zrepl-zfs-abstractions"><span class="std std-ref">what zrepl does to ensure</span></a> that replication between sender and receiver is always
possible without conflicts.
This will help you understand why certain kinds of multi-machine setups do not (yet) work.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you can’t find your desired configuration, have questions or would like to see improvements to multi-job setups, please <a class="reference external" href="https://github.com/zrepl/zrepl/issues/new">open an issue on GitHub</a>.</p>
</div>
<section id="multiple-jobs-on-one-machine">
<h3>Multiple Jobs on One Machine<a class="headerlink" href="#multiple-jobs-on-one-machine" title="Link to this heading"></a></h3>
<p>As a general rule, multiple jobs configured on one machine <strong>must operate on disjoint sets of filesystems</strong>.
Otherwise, concurrently running jobs might interfere when operating on the same filesystem.</p>
<p>On your setup, ensure that</p>
<ul class="simple">
<li><p>all <code class="docutils literal notranslate"><span class="pre">filesystems</span></code> filter specifications are disjoint</p></li>
<li><p>no <code class="docutils literal notranslate"><span class="pre">root_fs</span></code> is a prefix or equal to another <code class="docutils literal notranslate"><span class="pre">root_fs</span></code></p>
<ul>
<li><p>For <code class="docutils literal notranslate"><span class="pre">sink</span></code> jobs, consider all possible <code class="docutils literal notranslate"><span class="pre">root_fs/${client_identity}</span></code>.</p></li>
</ul>
</li>
<li><p>no <code class="docutils literal notranslate"><span class="pre">filesystems</span></code> filter matches any <code class="docutils literal notranslate"><span class="pre">root_fs</span></code></p></li>
</ul>
<p><strong>Exceptions to the rule</strong>:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">snap</span></code> and <code class="docutils literal notranslate"><span class="pre">push</span></code> job on the same machine can match the same <code class="docutils literal notranslate"><span class="pre">filesystems</span></code>.
To avoid interference, only one of the jobs should be pruning snapshots on the sender, the other one should keep all snapshots.
Since the jobs won’t coordinate, errors in the log are to be expected, but <a class="reference internal" href="#zrepl-zfs-abstractions"><span class="std std-ref">zrepl’s ZFS abstractions</span></a> ensure that <code class="docutils literal notranslate"><span class="pre">push</span></code> and <code class="docutils literal notranslate"><span class="pre">sink</span></code> can always replicate incrementally.
This scenario is detailed in one of the <a class="reference internal" href="../quickstart/backup_to_external_disk.html#quickstart-backup-to-external-disk"><span class="std std-ref">quick-start guides</span></a>.</p></li>
</ul>
</section>
<section id="two-or-more-machines">
<h3>Two Or More Machines<a class="headerlink" href="#two-or-more-machines" title="Link to this heading"></a></h3>
<p>This section might be relevant to users who wish to <em>fan-in</em> (N machines replicate to 1) or <em>fan-out</em> (replicate 1 machine to N machines).</p>
<p><strong>Working setups</strong>:</p>
<ul class="simple">
<li><p><strong>Fan-in: N servers replicated to one receiver, disjoint dataset trees.</strong></p>
<ul>
<li><p>This is the common use case of a centralized backup server.</p></li>
<li><p>Implementation:</p>
<ul>
<li><p>N <code class="docutils literal notranslate"><span class="pre">push</span></code> jobs (one per sender server), 1 <code class="docutils literal notranslate"><span class="pre">sink</span></code> (as long as the different push jobs have a different <a class="reference internal" href="#overview-passive-side-client-identity"><span class="std std-ref">client identity</span></a>)</p></li>
<li><p>N <code class="docutils literal notranslate"><span class="pre">source</span></code> jobs (one per sender server), N <code class="docutils literal notranslate"><span class="pre">pull</span></code> on the receiver server (unique names, disjoint  <code class="docutils literal notranslate"><span class="pre">root_fs</span></code>)</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">sink</span></code> job automatically constrains each client to a disjoint sub-tree of the sink-side dataset hierarchy <code class="docutils literal notranslate"><span class="pre">${root_fs}/${client_identity}</span></code>.
Therefore, the different clients cannot interfere.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">pull</span></code> job only pulls from one host, so it’s up to the zrepl user to ensure that the different <code class="docutils literal notranslate"><span class="pre">pull</span></code> jobs don’t interfere.</p></li>
</ul>
</li>
</ul>
<ul class="simple" id="fan-out-replication">
<li><p><strong>Fan-out: 1 server replicated to N receivers</strong></p>
<ul>
<li><p>Can be implemented either in a pull or push fashion.</p>
<ul>
<li><p><strong>pull setup</strong>: 1 <code class="docutils literal notranslate"><span class="pre">pull</span></code> job on each receiver server, each with a corresponding <strong>unique</strong> <code class="docutils literal notranslate"><span class="pre">source</span></code> job on the sender server.</p></li>
<li><p><strong>push setup</strong>: 1 <code class="docutils literal notranslate"><span class="pre">sink</span></code> job on each receiver server, each with a corresponding <strong>unique</strong> <code class="docutils literal notranslate"><span class="pre">push</span></code> job on the sender server.</p></li>
</ul>
</li>
<li><p>It is critical that we have one sending-side job (<code class="docutils literal notranslate"><span class="pre">source</span></code>, <code class="docutils literal notranslate"><span class="pre">push</span></code>) per receiver.
The reason is that <a class="reference internal" href="#zrepl-zfs-abstractions"><span class="std std-ref">zrepl’s ZFS abstractions</span></a> (<code class="docutils literal notranslate"><span class="pre">zrepl</span> <span class="pre">zfs-abstraction</span> <span class="pre">list</span></code>) include the name of the <code class="docutils literal notranslate"><span class="pre">source</span></code>/<code class="docutils literal notranslate"><span class="pre">push</span></code> job, but not the receive-side job name or client identity (see <a class="reference external" href="https://github.com/zrepl/zrepl/issues/380">issue #380</a>).
As a counter-example, suppose we used multiple <code class="docutils literal notranslate"><span class="pre">pull</span></code> jobs with only one <code class="docutils literal notranslate"><span class="pre">source</span></code> job.
All <code class="docutils literal notranslate"><span class="pre">pull</span></code> jobs would share the same <a class="reference internal" href="#replication-cursor-and-last-received-hold"><span class="std std-ref">replication cursor bookmark</span></a> and trip over each other, breaking incremental replication guarantees quickly.
The anlogous problem exists for 1 <code class="docutils literal notranslate"><span class="pre">push</span></code> to N <code class="docutils literal notranslate"><span class="pre">sink</span></code> jobs.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">filesystems</span></code> matched by the sending side jobs (<code class="docutils literal notranslate"><span class="pre">source</span></code>, <code class="docutils literal notranslate"><span class="pre">push</span></code>) need not necessarily be disjoint.
For this to work, we need to avoid interference between snapshotting and pruning of the different sending jobs.
The solution is to centralize sender-side snapshot management in a separate <code class="docutils literal notranslate"><span class="pre">snap</span></code> job.
Snapshotting in the <code class="docutils literal notranslate"><span class="pre">source</span></code>/<code class="docutils literal notranslate"><span class="pre">push</span></code> job should then be disabled (<code class="docutils literal notranslate"><span class="pre">type:</span> <span class="pre">manual</span></code>).
And sender-side pruning (<code class="docutils literal notranslate"><span class="pre">keep_sender</span></code>) needs to be disabled in the active side (<code class="docutils literal notranslate"><span class="pre">pull</span></code> / <code class="docutils literal notranslate"><span class="pre">push</span></code>), since that’ll be done by the <code class="docutils literal notranslate"><span class="pre">snap</span> <span class="pre">job</span></code>.</p></li>
<li><p><strong>Restore limitations</strong>: when restoring from one of the <code class="docutils literal notranslate"><span class="pre">pull</span></code> targets (e.g., using <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">send</span> <span class="pre">-R</span></code>), the replication cursor bookmarks don’t exist on the restored system.
This can break incremental replication to all other receive-sides after restore.</p></li>
<li><p>See <a class="reference internal" href="../quickstart/fan_out_replication.html#quickstart-fan-out-replication"><span class="std std-ref">the fan-out replication quick-start guide</span></a> for an example of this setup.</p></li>
</ul>
</li>
</ul>
<p><strong>Setups that do not work</strong>:</p>
<ul class="simple">
<li><p>N <code class="docutils literal notranslate"><span class="pre">pull</span></code> identities, 1 <code class="docutils literal notranslate"><span class="pre">source</span></code> job. Tracking <a class="reference external" href="https://github.com/zrepl/zrepl/issues/380">issue #380</a>.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../configuration.html" class="btn btn-neutral float-left" title="Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="jobs.html" class="btn btn-neutral float-right" title="Job Types in Detail" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2026, Christian Schwarz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: latest
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Releases</dt>
      <dd><a href="https://github.com/zrepl/zrepl/releases/tag/v0.7.0">v0.7.0</a></dd>
      <dd><a href="https://github.com/zrepl/zrepl/releases/tag/v0.6.1">v0.6.1</a></dd>
      <dd><a href="https://github.com/zrepl/zrepl/releases/tag/v0.5.0">v0.5.0</a></dd>
      <dd><a href="https://github.com/zrepl/zrepl/releases/tag/v0.4.0">v0.4.0</a></dd>
      <dd><a href="https://github.com/zrepl/zrepl/releases">All releases...</a></dd>
    </dl>
    <dl>
      <dt>Note</dt>
      <dd style="white-space: normal;">
        Release-specific docs are in the
        <span style="font-family: monospace;">zrepl-noarch.tar</span>
        asset on each GitHub release.
      </dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>