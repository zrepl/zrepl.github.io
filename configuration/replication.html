<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Replication Options &mdash; zrepl latest documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/banner.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=c6e86fd7"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Conflict Resolution Options" href="conflict_resolution.html" />
    <link rel="prev" title="Send &amp; Recv Options" href="sendrecvoptions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            zrepl
              <img src="../_static/zrepl.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                latest
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start by Use Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview &amp; Terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="jobs.html">Job Types in Detail</a></li>
<li class="toctree-l2"><a class="reference internal" href="transports.html">Transports</a></li>
<li class="toctree-l2"><a class="reference internal" href="filter_syntax.html">Filter Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="sendrecvoptions.html">Send &amp; Recv Options</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Replication Options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#protection-option"><code class="docutils literal notranslate"><span class="pre">protection</span></code> option</a></li>
<li class="toctree-l3"><a class="reference internal" href="#concurrency-option"><code class="docutils literal notranslate"><span class="pre">concurrency</span></code> option</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="conflict_resolution.html">Conflict Resolution Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="snapshotting.html">Taking Snaphots</a></li>
<li class="toctree-l2"><a class="reference internal" href="prune.html">Pruning Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pr.html">Talks &amp; Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../future.html">Future</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zrepl/zrepl">GitHub Repository &amp; Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://matrix.to/#/#zrepl:matrix.org">Chat: Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supporters.html">Supporters</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zrepl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../configuration.html">Configuration</a></li>
      <li class="breadcrumb-item active">Replication Options</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/zrepl/zrepl/blob/master/docs/configuration/replication.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="replication-options">
<span id="id1"></span><h1>Replication Options<a class="headerlink" href="#replication-options" title="Link to this heading"></a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jobs</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">push</span>
  <span class="n">filesystems</span><span class="p">:</span> <span class="o">...</span>
  <span class="n">replication</span><span class="p">:</span>
    <span class="n">protection</span><span class="p">:</span>
      <span class="n">initial</span><span class="p">:</span>     <span class="n">guarantee_resumability</span> <span class="c1"># guarantee_{resumability,incremental,nothing}</span>
      <span class="n">incremental</span><span class="p">:</span> <span class="n">guarantee_resumability</span> <span class="c1"># guarantee_{resumability,incremental,nothing}</span>
    <span class="n">concurrency</span><span class="p">:</span>
      <span class="n">size_estimates</span><span class="p">:</span> <span class="mi">4</span>
      <span class="n">steps</span><span class="p">:</span> <span class="mi">1</span>

  <span class="o">...</span>
</pre></div>
</div>
<section id="protection-option">
<span id="replication-option-protection"></span><h2><code class="docutils literal notranslate"><span class="pre">protection</span></code> option<a class="headerlink" href="#protection-option" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">protection</span></code> variable controls the degree to which a replicated filesystem is protected from getting out of sync through a zrepl pruner or external tools that destroy snapshots.
zrepl can guarantee <a class="reference internal" href="overview.html#step-holds"><span class="std std-ref">resumability</span></a> or just <a class="reference internal" href="overview.html#replication-cursor-and-last-received-hold"><span class="std std-ref">incremental replication</span></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">guarantee_resumability</span></code> is the <strong>default</strong> value and guarantees that a replication step is always resumable and that incremental replication will always be possible.
The implementation uses replication cursors, last-received-hold and step holds.</p>
<p><code class="docutils literal notranslate"><span class="pre">guarantee_incremental</span></code> only guarantees that incremental replication will always be possible.
If a step <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">-&gt;</span> <span class="pre">to</span></code> is interrupted and its <cite>to</cite> snapshot is destroyed, zrepl will remove the half-received <code class="docutils literal notranslate"><span class="pre">to</span></code>’s resume state and start a new step <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">-&gt;</span> <span class="pre">to2</span></code>.
The implementation uses replication cursors, tentative replication cursors and last-received-hold.</p>
<p><code class="docutils literal notranslate"><span class="pre">guarantee_nothing</span></code> does not make any guarantees with regards to keeping sending and receiving side in sync.
No bookmarks or holds are created to protect sender and receiver from diverging.</p>
<p><strong>Tradeoffs</strong></p>
<p>Using <code class="docutils literal notranslate"><span class="pre">guarantee_incremental</span></code> instead of <code class="docutils literal notranslate"><span class="pre">guarantee_resumability</span></code> obviously removes the resumability guarantee.
This means that replication progress is no longer monotonic which might lead to a replication setup that never makes progress if mid-step interruptions are too frequent (e.g. frequent network outages).
However, the advantage and <a class="reference external" href="https://github.com/zrepl/zrepl/issues/288">reason for existence</a> of the <code class="docutils literal notranslate"><span class="pre">incremental</span></code> mode is that it allows the pruner to delete snapshots of interrupted replication steps
which is useful if replication happens so rarely (or fails so frequently) that the amount of disk space exclusively referenced by the step’s snapshots becomes intolerable.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When changing this flag, obsoleted zrepl-managed bookmarks and holds will be destroyed on the next replication step that is attempted for each filesystem.</p>
</div>
</section>
<section id="concurrency-option">
<span id="replication-option-concurrency"></span><h2><code class="docutils literal notranslate"><span class="pre">concurrency</span></code> option<a class="headerlink" href="#concurrency-option" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">concurrency</span></code> options control the maximum amount of concurrency during replication.
The default values allow some concurrency during size estimation but no parallelism for the actual replication.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">concurrency.steps</span></code> (default = 1) controls the maximum number of concurrently executed <a class="reference internal" href="overview.html#overview-how-replication-works"><span class="std std-ref">replication steps</span></a>.
The planning step for each file system is counted as a single step.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">concurrency.size_estimates</span></code> (default = 4) controls the maximum number of concurrent step size estimations done by the job.</p></li>
</ul>
<p>Note that initial replication cannot start replicating child filesystems before the parent filesystem’s initial replication step has completed.</p>
<p>Some notes on tuning these values:</p>
<ul class="simple">
<li><p>Disk: Size estimation is less I/O intensive than step execution because it does not need to access the data blocks.</p></li>
<li><p>CPU: Size estimation is usually a dense CPU burst whereas step execution CPU utilization is stretched out over time because of disk IO.
Faster disks, sending a compressed dataset in <a class="reference internal" href="overview.html#zfs-background-knowledge-plain-vs-raw-sends"><span class="std std-ref">plain mode</span></a> and the zrepl transport mode all contribute to higher CPU requirements.</p></li>
<li><p>Network bandwidth: Size estimation does not consume meaningful amounts of bandwidth, step execution does.</p></li>
<li><p><a class="reference internal" href="overview.html#zrepl-zfs-abstractions"><span class="std std-ref">zrepl ZFS abstractions</span></a>: for each replication step zrepl needs to update its ZFS abstractions through the <code class="docutils literal notranslate"><span class="pre">zfs</span></code> command which often waits multiple seconds for the zpool to sync.
Thus, if the actual send &amp; recv time of a step is small compared to the time spent on zrepl ZFS abstractions then increasing step execution concurrency will result in a lower overall turnaround time.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="sendrecvoptions.html" class="btn btn-neutral float-left" title="Send &amp; Recv Options" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="conflict_resolution.html" class="btn btn-neutral float-right" title="Conflict Resolution Options" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2026, Christian Schwarz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: latest
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Releases</dt>
      <dd><a href="https://github.com/zrepl/zrepl/releases/tag/v0.6.1">v0.6.1</a></dd>
      <dd><a href="https://github.com/zrepl/zrepl/releases/tag/v0.5.0">v0.5.0</a></dd>
      <dd><a href="https://github.com/zrepl/zrepl/releases/tag/v0.4.0">v0.4.0</a></dd>
      <dd><a href="https://github.com/zrepl/zrepl/releases">All releases...</a></dd>
    </dl>
    <dl>
      <dt>Note</dt>
      <dd style="white-space: normal;">
        Release-specific docs are in the
        <span style="font-family: monospace;">zrepl-noarch.tar</span>
        asset on each GitHub release.
      </dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>