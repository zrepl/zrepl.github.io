

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Job Types &mdash; zrepl  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/banner.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="zrepl  documentation" href="../index.html"/>
        <link rel="up" title="Configuration" href="../configuration.html"/>
        <link rel="next" title="Transports" href="transports.html"/>
        <link rel="prev" title="Configuration" href="../configuration.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> zrepl
          

          
            
            <img src="../_static/zrepl.svg" class="logo" />
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Job Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#source-job">Source Job</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pull-job">Pull Job</a></li>
<li class="toctree-l3"><a class="reference internal" href="#local-job">Local Job</a></li>
<li class="toctree-l3"><a class="reference internal" href="#terminology">Terminology</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="transports.html">Transports</a></li>
<li class="toctree-l2"><a class="reference internal" href="map_filter_syntax.html">Mapping &amp; Filter Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="prune.html">Pruning Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../implementation.html">Implementation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/zrepl/zrepl">GitHub Repository &amp; Issue Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pr.html">Talks &amp; Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zrepl</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../configuration.html">Configuration</a> &raquo;</li>
        
      <li>Job Types</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/configuration/jobs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  





<div class="section" id="job-types">
<span id="job"></span><h1>Job Types<a class="headerlink" href="#job-types" title="Permalink to this headline">¶</a></h1>
<p>A <em>job</em> is the unit of activity tracked by the zrepl daemon and configured in the <a class="reference internal" href="../installation.html#mainconfigfile"><span class="std std-ref">main configuration file</span></a>.
Every job has a unique <code class="docutils literal"><span class="pre">name</span></code>, a <code class="docutils literal"><span class="pre">type</span></code> and type-dependent fields which are documented on this page.
Check out the <a class="reference internal" href="../tutorial.html#tutorial"><span class="std std-ref">Tutorial</span></a> and <a class="reference external" href="https://github.com/zrepl/zrepl/blob/master/cmd/sampleconf//">cmd/sampleconf/</a> for examples on how job types are actually used.</p>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">Currently, zrepl does not replicate filesystem properties.
Whe receiving a filesystem, it is never mounted (<cite>-u</cite> flag)  and <cite>mountpoint=none</cite> is set.
This is temporary and being worked on <a class="reference external" href="https://github.com/zrepl/zrepl/issues/24">issue #24</a>.</p>
</div>
<div class="section" id="source-job">
<span id="job-source"></span><h2>Source Job<a class="headerlink" href="#source-job" title="Permalink to this headline">¶</a></h2>
<p>Example: <a class="reference external" href="https://github.com/zrepl/zrepl/blob/master/cmd/sampleconf/pullbackup/productionhost.yml">cmd/sampleconfpullbackup/productionhost.yml</a>.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Comment</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">type</span></code></td>
<td>= <code class="docutils literal"><span class="pre">source</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">name</span></code></td>
<td>unique name of the job</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">serve</span></code></td>
<td><a class="reference internal" href="transports.html#transport-ssh-stdinserver-serve"><span class="std std-ref">serve transport</span></a></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">filesystems</span></code></td>
<td><a class="reference internal" href="map_filter_syntax.html#pattern-filter"><span class="std std-ref">filter</span></a> for filesystems to expose to client</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">snapshot_prefix</span></code></td>
<td>prefix for ZFS snapshots taken by this job</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">interval</span></code></td>
<td>snapshotting interval</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">prune</span></code></td>
<td><a class="reference internal" href="prune.html#prune"><span class="std std-ref">prune</span></a> policy for filesytems in <code class="docutils literal"><span class="pre">filesystems</span></code> with prefix <code class="docutils literal"><span class="pre">snapshot_prefix</span></code></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>Snapshotting Task (every <code class="docutils literal"><span class="pre">interval</span></code>, <a class="reference internal" href="#job-term-patient"><span class="std std-ref">patient</span></a>)<ul>
<li>A snapshot of filesystems matched by <code class="docutils literal"><span class="pre">filesystems</span></code> is taken every <code class="docutils literal"><span class="pre">interval</span></code> with prefix <code class="docutils literal"><span class="pre">snapshot_prefix</span></code>.</li>
<li>The <code class="docutils literal"><span class="pre">prune</span></code> policy is triggered on filesystems matched by <code class="docutils literal"><span class="pre">filesystems</span></code> with snapshots matched by <code class="docutils literal"><span class="pre">snapshot_prefix</span></code>.</li>
</ul>
</li>
<li>Serve Task<ul>
<li>Wait for connections from pull job using <code class="docutils literal"><span class="pre">serve</span></code>.</li>
</ul>
</li>
</ul>
<p>A source job is the counterpart to a <a class="reference internal" href="#job-pull"><span class="std std-ref">Pull Job</span></a>.</p>
<p>Note that the prune policy determines the maximum replication lag:
a pull job may stop replication due to link failure, misconfiguration or administrative action.
The source prune policy will eventually destroy the last common snapshot between source and pull job, requiring full replication.
Make sure you read the <a class="reference internal" href="prune.html#prune"><span class="std std-ref">prune</span></a> policy documentation.</p>
</div>
<div class="section" id="pull-job">
<span id="job-pull"></span><h2>Pull Job<a class="headerlink" href="#pull-job" title="Permalink to this headline">¶</a></h2>
<p>Example: <a class="reference external" href="https://github.com/zrepl/zrepl/blob/master/cmd/sampleconf/pullbackup/backuphost.yml">cmd/sampleconfpullbackup/backuphost.yml</a></p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Comment</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">type</span></code></td>
<td>= <code class="docutils literal"><span class="pre">pull</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">name</span></code></td>
<td>unqiue name of the job</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">connect</span></code></td>
<td><a class="reference internal" href="transports.html#transport-ssh-stdinserver-connect"><span class="std std-ref">connect transport</span></a></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">interval</span></code></td>
<td>Interval between pull attempts</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">mapping</span></code></td>
<td><a class="reference internal" href="map_filter_syntax.html#pattern-mapping"><span class="std std-ref">mapping</span></a> for remote to local filesystems</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">initial_repl_policy</span></code></td>
<td>default = <code class="docutils literal"><span class="pre">most_recent</span></code>, initial replication policy</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">snapshot_prefix</span></code></td>
<td>prefix snapshots must match to be considered for replication &amp; pruning</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">prune</span></code></td>
<td><a class="reference internal" href="prune.html#prune"><span class="std std-ref">prune</span></a> policy for local filesystems reachable by <code class="docutils literal"><span class="pre">mapping</span></code></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>Main Task (every <code class="docutils literal"><span class="pre">interval</span></code>, <a class="reference internal" href="#job-term-patient"><span class="std std-ref">patient</span></a>)<ol class="arabic">
<li>A connection to the remote source job is established using the strategy in <code class="docutils literal"><span class="pre">connect</span></code></li>
<li><code class="docutils literal"><span class="pre">mapping</span></code> maps filesystems presented by the remote side to local <em>target filesystems</em></li>
<li>Those remote filesystems with a local <em>target filesystem</em> are replicated<ol class="arabic">
<li>Only snapshots with prefix <code class="docutils literal"><span class="pre">snapshot_prefix</span></code> are replicated.</li>
<li>If possible, incremental replication takes place.</li>
<li>If the local target filesystem does not exist, <code class="docutils literal"><span class="pre">initial_repl_policy</span></code> is used.</li>
<li>On conflicts, an error is logged but replication of other filesystems with mapping continues.</li>
</ol>
</li>
<li>The <code class="docutils literal"><span class="pre">prune</span></code> policy is triggered for all <em>target filesystems</em></li>
</ol>
</li>
</ul>
<p>A pull job is the counterpart to a <a class="reference internal" href="#job-source"><span class="std std-ref">Source Job</span></a>.</p>
</div>
<div class="section" id="local-job">
<span id="job-local"></span><h2>Local Job<a class="headerlink" href="#local-job" title="Permalink to this headline">¶</a></h2>
<p>Example: <a class="reference external" href="https://github.com/zrepl/zrepl/blob/master/cmd/sampleconf/localbackup/host1.yml">cmd/sampleconflocalbackup/host1.yml</a></p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Comment</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">type</span></code></td>
<td>= <code class="docutils literal"><span class="pre">local</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">name</span></code></td>
<td>unqiue name of the job</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">mapping</span></code></td>
<td><a class="reference internal" href="map_filter_syntax.html#pattern-mapping"><span class="std std-ref">mapping</span></a> from source to target filesystem (both local)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">snapshot_prefix</span></code></td>
<td>prefix for ZFS snapshots taken by this job</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">interval</span></code></td>
<td>snapshotting &amp; replication interval</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">initial_repl_policy</span></code></td>
<td>default = <code class="docutils literal"><span class="pre">most_recent</span></code>, initial replication policy</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">prune_lhs</span></code></td>
<td>pruning policy on left-hand-side (source)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">prune_rhs</span></code></td>
<td>pruning policy on right-hand-side (target)</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>Main Task (every <code class="docutils literal"><span class="pre">interval</span></code>, <a class="reference internal" href="#job-term-patient"><span class="std std-ref">patient</span></a>)<ol class="arabic">
<li>Evaluate <code class="docutils literal"><span class="pre">mapping</span></code> for local filesystems, those with a <em>target filesystem</em> are called <em>mapped filesystems</em>.</li>
<li>Snapshot <em>mapped filesystems</em> with <code class="docutils literal"><span class="pre">snapshot_prefix</span></code>.</li>
<li>Replicate <em>mapped filesystems</em> to their respective <em>target filesystems</em>:<ol class="arabic">
<li>Only snapshots with prefix <code class="docutils literal"><span class="pre">snapshot_prefix</span></code> are replicated.</li>
<li>If possible, incremental replication takes place.</li>
<li>If the <em>target filesystem</em> does not exist, <code class="docutils literal"><span class="pre">initial_repl_policy</span></code> is used.</li>
<li>On conflicts, an error is logged but replication of other <em>mapped filesystems</em> continues.</li>
</ol>
</li>
<li>The <code class="docutils literal"><span class="pre">prune_lhs</span></code> policy is triggered for all <em>mapped filesystems</em></li>
<li>The <code class="docutils literal"><span class="pre">prune_rhs</span></code> policy is triggered for all <em>target filesystems</em></li>
</ol>
</li>
</ul>
<p>A local job is combination of source &amp; pull job executed on the same machine.</p>
</div>
<div class="section" id="terminology">
<h2>Terminology<a class="headerlink" href="#terminology" title="Permalink to this headline">¶</a></h2>
<p>task</p>
<blockquote>
<div>A job consists of one or more tasks and a task consists of one or more steps.
Some tasks may be periodic while others wait for an event to occur.</div></blockquote>
<p>patient task</p>
<blockquote>
<div><p id="job-term-patient">A patient task is supposed to execute some task every <cite>interval</cite>.
We call the start of the task an <em>invocation</em>.</p>
<ul class="simple">
<li>If the task completes in less than <cite>interval</cite>, the task is restarted at <cite>last_invocation + interval</cite>.</li>
<li><dl class="first docutils">
<dt>Otherwise, a patient job</dt>
<dd><ul class="first last">
<li>logs a warning as soon as a task exceeds its configured <cite>interval</cite></li>
<li>waits for the last invocation to finish</li>
<li>logs a warning with the effective task duration</li>
<li>immediately starts a new invocation of the task</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="transports.html" class="btn btn-neutral float-right" title="Transports" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../configuration.html" class="btn btn-neutral" title="Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Christian Schwarz.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: master
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../0.0.2/configuration/jobs.html">0.0.2</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../master/configuration/jobs.html">master</a></dd>
        </dl>
    </div>
</div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>